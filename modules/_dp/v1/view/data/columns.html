<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>表字段</title>
    <link href="/static/_dp/css/bootstrap.css" rel="stylesheet">
    <link href="/static/_dp/css/site.css" rel="stylesheet">
    <link href="/static/_dp/css/bg.css" rel="stylesheet">

    <script src="/static/_dp/js/hammer/kl-hammer.js"></script>
    <script src="/static/_dp/js/string/string.js"></script>
    <script src="/static/_dp/js/hammer-yii2/bootstrap.min.2022.10.07.0.js"></script>
    <script src="/static/_dp/js/hammer-yii2/datagrid/datagrid.min.2023.06.13.js"></script>
    <script src="/static/_dp/js/hammer/hammer-object-check.js"></script>
    <script src="/static/_dp/js/bg.js"></script>
    <script src="/static/_dp/js/hammer-bg-dbdata.js"></script>

    <script src="/static/_dp/js/jquery.js"></script>
    <script src="/static/_dp/js/bootstrap.js"></script>

</head>
<body>
<div class="wrap">
    <nav id="w0" class="navbar-inverse navbar-fixed-top navbar">
        <div class="container">
            <div id="page_title" class="navbar-brand page_title">【管理-字段】</div>
        </div>
    </nav>
    <div class="container">
        <div class="site-index">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="page-header" id="h1">【管理-字段】</h3>
                </div>
                <div class="panel-body">
                    <p id="subject_detail"></p>
                </div>
            </div>
            <div class="body-content" id="content_div">
            </div>
        </div>
    </div>
</div>


<script>
    domLoaded(function () {
            let utk = '';

            bg_init(function () {
                utk = window.utk;

                window.serverData.dataLib = {
                    admin: {items: [], list: [], map: {}},
                    role: {items: [], list: [], map: {}},
                    mainTable: {},
                    dbdataColumnTable: {}

                };

                window.serverData.dataLib.bgDataApi = hammerBgDataApi();
                window.serverData.dataLib.bgDataApi.setUserToken(utk);
                window.serverData.dataLib.bgDataApi.setMainTableName(window.serverData.dbconf_name, window.serverData.table_name);
                (async function () {

                    await window.serverData.dataLib.bgDataApi.init_DbColumnConf_ConfigInfo(function () {
                        console.log('数据库配置初始化 1');
                    });
                    console.log('数据库配置初始化');

                    await window.serverData.dataLib.bgDataApi.initRoles(() => {
                        console.log('角色初始化 1');
                    });
                    console.log('角色初始化');

                    await window.serverData.dataLib.bgDataApi.init_MainTable_ConfigInfo(() => {
                        console.log('主表初始化 1');
                    });
                    console.log('主表初始化');


                    content();
                })();

                // getRoles(() => {
                //     getDbdataColumnTableInfo(() => {
                //         getMainTableInfo(() => {
                //             content();
                //         })
                //     })
                // })
            });


            content = function () {
                kl.id('h1').textContent = kl.id('h1').textContent + '/' + window.serverData.dataLib.mainTable.tableInfo.title + '/ ' + window.serverData.table_name;
                document.title = '【列】' + window.serverData.dataLib.mainTable.tableInfo.title + '/' + serverData.table.table_name;


                let rolesTable = () => {
                    let role_table = new Emt('table').setAttrsByStr('class="table table-bordered table-striped table-hover"');
                    let role_table_header = role_table.createTHead();
                    let role_tr_header = role_table_header.insertRow();
                    role_tr_header.insertCell().textContent = '角色';
                    role_tr_header.insertCell().textContent = '读';
                    role_tr_header.insertCell().textContent = '改(选写)';
                    role_tr_header.insertCell().textContent = '增/删';
                    let role_table_body = role_table.createTBody();

                    role_table.col_select_role_checkbosx = [];
                    role_table.col_update_role_checkboxs = [];

                    window.serverData.dataLib.role.list.forEach(function (roleInfo) {
                        let body_tr = role_table_body.insertRow();
                        body_tr.role_td = body_tr.insertCell();
                        body_tr.read_td = body_tr.insertCell();
                        body_tr.opts_td = body_tr.insertCell();
                        body_tr.add_td = body_tr.insertCell();
                        body_tr.role_td.textContent = roleInfo.role_name;
                        body_tr.read_role_checkbox = new Emt('input', 'type="checkbox"', '', {value: roleInfo.role_code});
                        body_tr.update_role_checkbox = new Emt('input', 'type="checkbox"', '', {value: roleInfo.role_code});
                        role_table.col_select_role_checkbosx.push(body_tr.read_role_checkbox);
                        role_table.col_update_role_checkboxs.push(body_tr.update_role_checkbox);
                        body_tr.read_td.append(new Emt('label', '', '#').addNodes([body_tr.read_role_checkbox, new Emt('span', '', '#')]));
                        body_tr.opts_td.append(new Emt('label', '', '#').addNodes([body_tr.update_role_checkbox, new Emt('span', '', '#')]));

                    });
                    role_table.loadColumnsRoles = (dataRow) => {
                        role_table.col_select_role_checkbosx.forEach((checkbox) => {
                            checkbox.checked = dataRow.access_select_role_codes.indexOf(checkbox.value) > -1;
                        });
                        role_table.col_update_role_checkboxs.forEach((checkbox) => {
                            checkbox.checked = dataRow.access_update_role_codes.indexOf(checkbox.value) > -1;
                        });
                    };
                    role_table.getRoleCodes = () => {
                        let res = {select: [], update: []};
                        role_table.col_select_role_checkbosx.forEach((checkbox) => {
                            if (checkbox.checked) {
                                res.select.push(checkbox.value);
                            }
                        });
                        role_table.col_update_role_checkboxs.forEach((checkbox) => {
                            if (checkbox.checked) {
                                res.opt.push(checkbox.value);
                            }
                        });
                        return res;
                    };
                    return role_table;
                };
                let createValueItemsTable = () => {
                    let items_table = new Emt('table').setAttrsByStr('class="table table-bordered table-striped table-hover"');
                    let ele_vals_submit_btn = new Emt('button', 'type="button"').setPros({textContent: '应用到取值范围'});
                    let tmp_table_header = items_table.createTHead();
                    let tmp_tr_header = tmp_table_header.insertRow();
                    tmp_tr_header.insertCell().textContent = '序号';
                    tmp_tr_header.insertCell().textContent = '值';
                    tmp_tr_header.insertCell().textContent = '标签/含义';
                    tmp_tr_header.insertCell().textContent = '启用';

                    items_table.TBody = items_table.createTBody();
                    items_table.apiHandle = {
                        trs: [],
                        acceptJsonInputElement: false
                    };
                    items_table.apiHandle.addItemRow = function (val_info) {
                        let item_tr = items_table.TBody.insertRow();
                        items_table.apiHandle.trs.push(item_tr);
                        item_tr.val_input = new Emt('input').setAttrsByStr('type="text"');
                        item_tr.text_input = new Emt('input').setAttrsByStr('type="text"');
                        item_tr.check_input = new Emt('input').setAttrsByStr('type="checkbox"');
                        item_tr.insertCell().textContent = items_table.apiHandle.trs.length.toString();
                        item_tr.insertCell().append(item_tr.val_input);
                        item_tr.insertCell().append(item_tr.text_input);
                        item_tr.insertCell().append(item_tr.check_input);
                        item_tr.loadInfo = (valItemInfo) => {
                            item_tr.val_input.value = valItemInfo.val || '';
                            item_tr.text_input.value = valItemInfo.text || '';
                            item_tr.check_input.checked = true;
                        };
                        return item_tr;
                    };

                    let tmp_table_footer = items_table.createTFoot();

                    let tmp_tr_footer = tmp_table_footer.insertRow();
                    let add_val_setting_btn = new Emt('button', 'type="button"').setPros({textContent: '添加item'});
                    tmp_tr_footer.insertCell().textContent = '#';
                    //tmp_tr_footer.insertCell().textContent = '#';
                    tmp_tr_footer.insertCell().append(add_val_setting_btn);
                    tmp_tr_footer.insertCell().append(ele_vals_submit_btn);


                    ele_vals_submit_btn.addEventListener('click', function () {
                        if (items_table.apiHandle.acceptJsonInputElement === false) {
                            console.log('没有设置 acceptJsonInputElement:', items_table.getItems());
                        } else {
                            items_table.apiHandle.acceptJsonInputElement.value = JSON.stringify(items_table.getItems());
                        }
                    });
                    add_val_setting_btn.addEventListener('click', function () {
                        items_table.apiHandle.addItemRow().check_input.checked = true;
                    });
                    items_table.clearItems = () => {
                        items_table.TBody.innerHTML = '';
                        items_table.apiHandle.trs = [];
                        return items_table;
                    };
                    items_table.getItems = () => {
                        let items = [];
                        items_table.apiHandle.trs.forEach((tr) => {
                            if (tr.check_input.checked === true) {
                                items.push({
                                    val: tr.val_input.value,
                                    text: tr.text_input.value,
                                });
                            }
                        });
                        return items;
                    };
                    items_table.loadItems = (items) => {
                        items.forEach((itemInfo) => {
                            items_table.apiHandle.addItemRow().loadInfo(itemInfo);
                        });
                    };
                    items_table.setAcceptJsonInputElement = (inputElement) => {
                        items_table.apiHandle.acceptJsonInputElement = inputElement;
                        return items_table;
                    };
                    return items_table;
                };

                let raw_root = kl.id('content_div');
                let root = new Emt('div').setPros({className: 'row'});
                raw_root.append(root);


                let add_row_btn = new Emt('button', 'class="btn btn-md btn-info"', '').addNodes([
                    new Emt('span', 'class=" glyphicon glyphicon-plus"'),
                    new Emt('span', '', '新增')
                ]);
                let search_btn = new Emt('button', 'class="btn btn-md btn-info"', '').addNodes([
                    //  new Emt('span','class="glyphicon glyphicon-play"'),
                    new Emt('span', 'class="glyphicon glyphicon-ok"'),
                    new Emt('span', '', '查询')
                ]);
                let operation_div = new Emt('div');

                let info_div = new Emt('div');
                let datagrid_div = new Emt('div');
                let fixed_tools_div = new Emt('div', 'class="fixed_tools_div"');


                root.addNodes([
                    operation_div.addNodes([]),
                    info_div.addNodes([]),
                    datagrid_div,
                    fixed_tools_div.addNodes([
                        //add_row_btn,
                        search_btn,
                    ])
                ]);

                let hammerYii2Bootstarp1 = hammerYii2Bootstarp();
                let modal_edit = hammerYii2Bootstarp1.createModal({title: '修改字段设置'});
                let form_edit = hammerYii2Bootstarp1.createForm({dataNameTpl: 'attr[$var]'});

                modal_edit.apiHandle.ele.body.addNodes([form_edit]);
                form_edit.apiHandle.addGroupPreCreate().setLabelText('字段').setIndexKey('column_name').create('text');
                let column_name_input = form_edit.apiHandle.ele.input.column_name;

                form_edit.apiHandle.addGroupPreCreate().setNameVar('id').setIndexKey('id').create('hide');
                let column_id_input = form_edit.apiHandle.ele.input.id;

                form_edit.apiHandle.addGroupPreCreate().setLabelText('字段标题').setPlaceHolder('用于当成label显示').setIndexKey('title').setNameVar('title').create('text');
                let column_title_input = form_edit.apiHandle.ele.input.title;


                form_edit.apiHandle.addGroupPreCreate().setLabelText('字段序号').setPlaceHolder('大->小').setIndexKey('sn').setNameVar('column_sn').create('number');
                let column_sn_input = form_edit.apiHandle.ele.input.sn;


                form_edit.apiHandle.addGroupPreCreate().setLabelText('字段描述').setPlaceHolder('备注').setIndexKey('remark').setNameVar('remark').create('textarea');
                let column_remark_input = form_edit.apiHandle.ele.input.remark;


                form_edit.apiHandle.addGroupPreCreate().setLabelText('取值范围').setPlaceHolder('代表值对应含义').setIndexKey('val_items').setNameVar('val_items').create('textarea');
                let column_valRange_input = form_edit.apiHandle.ele.input.val_items;


                let edit_vals_div = new Emt('div').setAttrsByStr('class="table-responsive"');

                let tmp_group = hammerYii2Bootstarp1.createFormInputGroupDiv({});
                tmp_group.apiHandle.setText('').apiHandle.addInputEle(edit_vals_div);
                form_edit.addNode(tmp_group);
                let valueRangeTable = createValueItemsTable();
                edit_vals_div.addNodes([
                    new Emt('div').setAttrsByStr('class="table-responsive"').addNodes([valueRangeTable])
                ]);
                valueRangeTable.setAcceptJsonInputElement(column_valRange_input);


                form_edit.apiHandle.addGroupPreCreate().setLabelText('输出类型').setIndexKey('out_datatype').setNameVar('out_datatype').setItems([
                    {text: 'string', val: 'string'},
                    {text: 'int', val: 'int'},
                    {text: 'date', val: 'date'},
                    {text: 'img_uri', val: 'img_uri'}
                ]).create('select');
                let column_outDataType_input = form_edit.apiHandle.ele.input.out_datatype;


                form_edit.apiHandle.addGroupPreCreate().setLabelText('接收类型').setIndexKey('in_datatype').setNameVar('in_datatype').setItems([
                    {text: 'string', val: 'string'},
                    {text: 'int', val: 'int'},
                    {text: 'date', val: 'date'}
                ]).create('select');
                let column_inDataType_input = form_edit.apiHandle.ele.input.in_datatype;


                form_edit.apiHandle.addGroupPreCreate().setLabelText('页面输入类型').setIndexKey('query_input_type').setNameVar('query_input_type').setItems(serverData.dataLib.dbdataColumnTable.__column.map.query_input_type.val_items).create('select');
                let column_queryInputType_input = form_edit.apiHandle.ele.input.query_input_type;

                form_edit.apiHandle.addGroupPreCreate().setLabelText('是否有datalist').setIndexKey('has_query_datalist').setNameVar('has_query_datalist').setItems(serverData.dataLib.dbdataColumnTable.__column.map.has_query_datalist.val_items).create('select');
                let column_hasQueryDatalist_input = form_edit.apiHandle.ele.input.has_query_datalist;

                form_edit.apiHandle.addGroupPreCreate().setLabelText('多值查询').setIndexKey('is_query_multi').setNameVar('is_query_multi').setItems(serverData.dataLib.dbdataColumnTable.__column.map.is_query_multi.val_items).create('select');
                let column_isQueryMulti_input = form_edit.apiHandle.ele.input.is_query_multi;


                let role_table = rolesTable();
                let role_groupDiv = hammerYii2Bootstarp1.createFormInputGroupDiv({});
                role_groupDiv.apiHandle.setText('权限控制').apiHandle.addInputEle(role_table);
                form_edit.addNode(role_groupDiv);


                //label, text, handle_ele_key, callback
                form_edit.apiHandle.addGroupPreCreate().setType('button').setContentText('保存').setIndexKey('submit').setClickCall(function (btn) {
                    let rolecodes_map = role_table.getRoleCodes();

                    console.log(btn, this, form_edit.apiHandle, rolecodes_map);
                    //  return false;
                    kl.ajax({
                        url: '/_dp/v1/dbdata/update?user_token=' + utk,
                        //attr: form,
                        data: {
                            attr: {
                                id: form_edit.apiHandle.ele.input.id.apiHandle.getVal(),
                                title: form_edit.apiHandle.ele.input.title.apiHandle.getVal(),
                                column_sn: form_edit.apiHandle.ele.input.sn.apiHandle.getVal(),
                                out_datatype: form_edit.apiHandle.ele.input.out_datatype.apiHandle.getVal(),
                                in_datatype: form_edit.apiHandle.ele.input.in_datatype.apiHandle.getVal(),
                                val_items: form_edit.apiHandle.ele.input.val_items.apiHandle.getVal(),
                                remark: form_edit.apiHandle.ele.input.remark.apiHandle.getVal(),
                                access_select_role_codes: JSON.stringify(rolecodes_map.select),
                                access_update_role_codes: JSON.stringify(rolecodes_map.update),
                                query_input_type: form_edit.apiHandle.ele.input.query_input_type.apiHandle.getVal(),
                                has_query_datalist: form_edit.apiHandle.ele.input.has_query_datalist.apiHandle.getVal(),
                                is_query_multi: form_edit.apiHandle.ele.input.is_query_multi.apiHandle.getVal(),


                            },
                            dbconf_name: serverData.dataLib.bgDataApi.config.dbconf_name,
                            table_name: window.serverData.dataLib.bgDataApi.config.dbdata_column_tableName,
                        },
                        type: 'json',
                        success: function (res_save_column) {
                            if (res_save_column.status) {
                                if (res_save_column.status === 200) {
                                    datagrid.api.requestData('init');
                                    //res_save_column(res_save_column.data);
                                    modal_edit.apiHandle.hide();
                                } else {
                                    alert('错误:' + (res_save_column.msg || '未知'))
                                }
                            } else {
                                console.log(res_save_column);
                                alert('请求结果异常')
                            }
                        },
                        error: function (res_save_column) {
                            console.log(res_save_column);
                            alert('网络异常');
                        }
                    })
                }).create('button');


                let id_list = [];
                let sort_bar_list = [];
                let rowIndexCount = 0;

                let config = {
                    container: datagrid_div,
                    components: {//部件，datagrid 默认的部件
                        totalInformation: true,//是否展示 数据多少行 多少页信息，自定义的话，可以在request.after定义
                        pageInfomation: true,//分页操作
                        requestInformation: true,//请求信息，条件 排序 分期
                    },
                    dataSource: {//请求设置
                        url: '/_dp/v1/dbdata/select',
                        downloadable: false,//可下载数据
                        beforeRequest: (event_type, dataGrid) => {
                            id_list = [];
                            sort_bar_list = [];
                            console.log(event_type, dataGrid);
                            // let page_data = dataGrid.api.getRequestParam();
                            if (event_type === 'filter') {
                                console.log('这个不做理会，不然请求太频繁了');
                                return false;
                            }
                            return true;
                        },
                        param: {
                            append: {
                                dbconf_name: serverData.dataLib.bgDataApi.config.dbconf_name,
                                table_name: window.serverData.dataLib.bgDataApi.config.dbdata_column_tableName,
                            },
                            fun: (post_data) => {
                                post_data.attr.table_name = window.serverData.dataLib.mainTable.tableInfo.table_name;
                                post_data.attr.dbconf_name = window.serverData.dataLib.mainTable.tableInfo.dbconf_name;

                                return post_data;
                            },
                        },
                        resultAdapter: (request_res) => {
                            rowIndexCount = 0;
                            if (request_res.status) {
                                if (request_res.status === 200) {
                                    return request_res.data;
                                } else {
                                    alert('错误:' + (request_res.msg || '未知'))
                                }
                            } else {
                                console.log(request_res.status);
                                alert('请求结果异常')
                            }
                            return request_res;
                        },
                        afterRequest: (request_res, dataGrid) => {

                        },
                        requestButtons: [
                            true,//发请求事件的按钮，第一个代表是否自动生成
                        ],
                    },
                    paramPreset: {
                        attr: serverData.presetAttr || {//过滤器
                            // id: 1,
                        },
                        page: serverData.presetPage || {//分页
                            index: 1,
                            size: 1000,
                            sizes: [],
                        },
                        sort: serverData.presetSort || {//排序
                            id: 'desc'
                        }
                    },

                    columns: [
                        {
                            handleKey: '_rowIndexCount',
                            attrKey: false,
                            headerText: 'i',
                            sortable: false,
                            filter: {
                                inputs: [
                                    false
                                ],
                                config: {
                                    valueItems: []
                                }
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                rowIndexCount++;
                                cell.textContent = rowIndexCount.toString();
                            },
                        },
                        {
                            handleKey: 'id',
                            attrKey: 'id',
                            headerText: 'ID',
                            sortable: true,
                            filter: {//过滤器
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.id;
                            },
                        },


                        {
                            handleKey: 'dbconf_name',
                            attrKey: 'dbconf_name',
                            headerText: '数据库',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.dbconf_name;
                            },
                        },
                        {
                            handleKey: 'table_name',
                            attrKey: 'table_name',
                            headerText: '表名',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.table_name;
                            },
                        },
                        {
                            handleKey: 'column_sn',
                            attrKey: 'column_sn',
                            headerText: '排序',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                let input_data = datagrid.api.getRequestParam();
                                // console.log(input_data);
                                if (input_data.sort.column_sn !== undefined && input_data.sort.column_sn === 'desc') {
                                    id_list.push(parseInt(row_data.id));
                                    let bar_btn = new Emt('button', 'type="button"', row_data.column_sn, {draggable: true, sn: parseInt(row_data.column_sn), data_id: parseInt(row_data.id)});
                                    let pre_area = new Emt('div', '', '<--', {sn: parseInt(row_data.column_sn), data_id: parseInt(row_data.id)});
                                    let next_area = new Emt('div', '', '-->', {sn: parseInt(row_data.column_sn), data_id: parseInt(row_data.id)});
                                    sort_bar_list.push(bar_btn);
                                    let tmp_div = new Emt('div', 'class="drag_sort_div"');
                                    tmp_div.addNodes([pre_area, bar_btn, next_area]);
                                    cell.appendChild(tmp_div);

                                    bar_btn.addEventListener('dragstart', function (e) {
                                        console.log('dragstart', e.target);
                                        window.dragedEle = bar_btn;
                                    });
                                    bar_btn.addEventListener('drag', function (e) {
                                        //console.log('drag');

                                    });
                                    bar_btn.addEventListener('dragend', function (e) {
                                        console.log('dragend');
                                        window.dragedEle = false;
                                    });

                                    pre_area.addEventListener('dragenter', function (e) {
                                        //console.log('dragenter');
                                    });
                                    pre_area.addEventListener('drop', function (e) {
                                        let tmp_index = id_list.indexOf(pre_area.data_id);
                                        let tmp_ar = [];
                                        if (tmp_index === 0) {
                                            tmp_ar.push(window.dragedEle.data_id);
                                        }
                                        id_list.forEach((data_id) => {
                                            if (window.dragedEle.data_id !== data_id) {
                                                tmp_ar.push(data_id);
                                            }
                                        });
                                        console.log('PRE drop', pre_area, pre_area.data_id, window.dragedEle, window.dragedEle.data_id, tmp_ar);

                                        kl.ajax({
                                            url: '/_dp/v1/dbdata/sortColumn?user_token=' + utk,
                                            data: {
                                                ids: tmp_ar
                                            },
                                            type: 'json',
                                            success: function (tmp_res) {
                                                datagrid.api.requestData('init');
                                            },
                                            error: function (res_save_column) {
                                                alert('报错了');
                                            }
                                        })

                                    });
                                    pre_area.addEventListener('dragover', function (e) {
                                        // console.log('dragover');
                                        e.preventDefault(); //【重要】一定要加这一行代码，否则，后面的方法 ondrop() 无法触发。

                                    });
                                    pre_area.addEventListener('dragleave', function (e) {
                                        //console.log('dragleave');
                                    });


                                    next_area.addEventListener('dragenter', function (e) {
                                        //console.log('dragenter');
                                    });
                                    next_area.addEventListener('drop', function (e) {
                                        let tmp_ar = [];
                                        id_list.forEach((data_id, index) => {
                                            if (data_id !== window.dragedEle.data_id) {
                                                if (data_id === next_area.data_id) {
                                                    tmp_ar.push(data_id);
                                                    tmp_ar.push(window.dragedEle.data_id);
                                                } else {
                                                    tmp_ar.push(data_id);
                                                }
                                            }
                                        });
                                        console.log('NEXT drop', pre_area, pre_area.data_id, window.dragedEle, window.dragedEle.data_id, tmp_ar);
                                        kl.ajax({
                                            url: '/_dp/v1/dbdata/sortColumn?user_token=' + utk,
                                            data: {
                                                ids: tmp_ar
                                            },
                                            type: 'json',
                                            success: function (tmp_res) {
                                                datagrid.api.requestData('init');
                                            },
                                            error: function (res_save_column) {
                                                alert('报错了');
                                            }
                                        })

                                    });
                                    next_area.addEventListener('dragover', function (e) {
                                        // console.log('dragover');
                                        e.preventDefault(); //【重要】一定要加这一行代码，否则，后面的方法 ondrop() 无法触发。

                                    });
                                    next_area.addEventListener('dragleave', function (e) {
                                        //console.log('dragleave');
                                    });

                                } else {
                                    cell.textContent = row_data.column_sn;
                                }

                            },
                        },
                        {
                            handleKey: 'title',
                            attrKey: 'title',
                            headerText: '标题',
                            sortable: true,
                            filter: {//过滤器
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.title;
                            },
                        },
                        {
                            handleKey: 'column_name',
                            attrKey: 'column_name',
                            headerText: '列字段名',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.column_name;
                            },
                        },
                        {
                            handleKey: 'data_type',
                            attrKey: 'data_type',
                            headerText: '类型',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.db_datatype + '(' + row_data.db_datatype_len.toString() + '])';
                            },
                        },
                        {
                            handleKey: 'in_datatype',
                            attrKey: 'in_datatype',
                            headerText: '接收类型',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.in_datatype;
                            },
                        },
                        {
                            handleKey: 'out_datatype',
                            attrKey: 'out_datatype',
                            headerText: '展示类型',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.out_datatype;
                            },
                        },
                        {
                            handleKey: 'val_items',
                            attrKey: 'val_items',
                            headerText: '字段值范围',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                let tmp_pre = new Emt('pre');
                                //  console.log(row_data.column_name);
                                if (0) {
                                    if (window.serverData.vals_range_map[row_data.column_name] !== undefined && window.serverData.vals_range_map[row_data.column_name].length) {
                                        let tmp_strs = [];
                                        window.serverData.vals_range_map[row_data.column_name].forEach(function (val_opt_info) {
                                            tmp_strs.push(JSON.stringify(val_opt_info));
                                        });
                                        tmp_pre.textContent = tmp_strs.join("\n");
                                        tmp_pre.textContent = JSON.stringify(window.serverData.vals_map[row_data.column_name], null, 2);
                                    } else {
                                        tmp_pre.textContent = '自由定义';
                                    }
                                } else {
                                    if (row_data.val_items !== undefined && row_data.val_items !== null && row_data.val_items.length && row_data.val_items !== '[]') {
                                        let tmp_val_items = JSON.parse(row_data.val_items);
                                        console.log(row_data.val_items, typeof row_data.val_items);
                                        let tmp_strs = [];
                                        tmp_val_items.forEach(function (val_opt_info) {
                                            tmp_strs.push(JSON.stringify(val_opt_info));
                                        });
                                        tmp_pre.textContent = tmp_strs.join("\n");
                                        //  tmp_pre.textContent = JSON.stringify(tmp_strs, null, 2);
                                    } else {
                                        tmp_pre.textContent = '自由定义';
                                    }
                                }
                                cell.addNodes([
                                    tmp_pre
                                ]);

                            },
                        },
                        {
                            handleKey: 'is_ok',
                            attrKey: 'is_ok',
                            headerText: '禁用',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.addNodes([
                                    new Emt('p').setAttrsByStr('', (window.serverData.dataLib.dbdataColumnTable.__column.map.is_ok.valItemMap[row_data.is_ok] || '错误信息')),
                                ]);
                            },
                        },
                        {
                            handleKey: 'remark',
                            attrKey: 'remark',
                            headerText: '备注',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.remark;
                            },
                        },
                        {
                            handleKey: 'access_select_role_codes',
                            attrKey: 'access_select_role_codes',
                            headerText: 'access_select_role_codes',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.access_select_role_codes;
                            },
                        },
                        {
                            handleKey: 'access_update_role_codes',
                            attrKey: 'access_update_role_codes',
                            headerText: 'access_update_role_codes',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.access_update_role_codes;
                            },
                        },
                        {
                            handleKey: 'query_input_type',
                            attrKey: 'query_input_type',
                            headerText: '页面查询类型',
                            sortable: false,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.addNodes([
                                    new Emt('p').setAttrsByStr('', (window.serverData.dataLib.dbdataColumnTable.__column.map.query_input_type.valItemMap[row_data.query_input_type] || ('错误信息:' + row_data.query_input_type))),
                                ]);
                            },
                        },
                        {
                            handleKey: 'has_query_datalist',
                            attrKey: 'has_query_datalist',
                            headerText: 'datalist?',
                            sortable: false,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.addNodes([
                                    new Emt('p').setAttrsByStr('', (window.serverData.dataLib.dbdataColumnTable.__column.map.has_query_datalist.valItemMap[row_data.has_query_datalist] || '错误信息')),
                                ]);
                            },
                        },
                        {
                            handleKey: 'is_query_multi',
                            attrKey: 'is_query_multi',
                            headerText: '多项查询?',
                            sortable: false,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.addNodes([
                                    new Emt('p').setAttrsByStr('', (window.serverData.dataLib.dbdataColumnTable.__column.map.is_query_multi.valItemMap[row_data.is_query_multi] || '错误信息')),
                                ]);
                            },
                        },
                        {
                            handleKey: 'default_opts',
                            attrKey: 'default_opts',
                            headerText: 'default_opts',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.default_opts;
                            },
                        },
                        {
                            handleKey: 'create_time',
                            attrKey: 'create_time',
                            headerText: '创建时间',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                cell.textContent = row_data.create_time;
                            },
                        },
                        {
                            handleKey: 'op',
                            attrKey: false,
                            headerText: '操作',
                            sortable: true,
                            filter: {
                                inputs: [true],
                                config: {valueItems: []}
                            },
                            info: {},
                            fun: (cell, row_data) => {
                                let btn_import_column = new Emt('button').setPros({textContent: '修改'});
                                btn_import_column.addEventListener('click', function () {

                                    console.log('修改', cell, row_data);
                                    valueRangeTable.clearItems();
                                    // column_name_input_ele.value = row_data.column_name;

                                    modal_edit.data_info = {cell: cell, row_data: row_data};
                                    column_id_input.value = row_data.id;
                                    column_name_input.value = row_data.column_name;
                                    column_title_input.value = row_data.title;
                                    column_sn_input.value = row_data.column_sn;
                                    column_remark_input.value = row_data.remark;
                                    column_inDataType_input.apiHandle.setInitVal(row_data.in_datatype);
                                    column_outDataType_input.apiHandle.setInitVal(row_data.out_datatype);

                                    column_queryInputType_input.apiHandle.setInitVal(row_data.query_input_type);
                                    column_hasQueryDatalist_input.apiHandle.setInitVal(row_data.has_query_datalist);
                                    column_isQueryMulti_input.apiHandle.setInitVal(row_data.is_query_multi);

                                    let tmp_obj = {};
                                    ['access_select_role_codes', 'access_update_role_codes'].forEach((column_name) => {
                                        if (row_data[column_name] === null) {
                                            tmp_obj[column_name] = [];
                                        } else {
                                            try {
                                                tmp_obj[column_name] = JSON.parse(row_data[column_name]);
                                            } catch (e) {
                                                tmp_obj[column_name] = [];
                                            }
                                        }
                                    });
                                    role_table.loadColumnsRoles(tmp_obj);

                                    if (row_data.val_items === null) {
                                        row_data.val_items = '[]';
                                    }
                                    column_valRange_input.value = row_data.val_items;

                                    let tmp_val_items = JSON.parse(row_data.val_items);
                                    valueRangeTable.loadItems(tmp_val_items);

                                    //handle_in_datatype_select.loadVal([row_data.out_datatype,'string','int','date']);


                                    modal_edit.apiHandle.show();
                                });
                                cell.addNodes([btn_import_column]);
                            },
                        },
                    ],
                };
                let datagrid = hammerBootstarpAsyncDatagrid(config);
                console.log('datagrid', datagrid);


                datagrid.api.init();
                search_btn.addEventListener('click', function () {
                    datagrid.api.requestData('search_btn');
                });
                datagrid.api.requestData('init');


            }
        }
    );
</script>
<style>
    .drag_sort_div {
        float: left;
        width: 100px;
    }

    .drag_sort_div > * {
        display: block;
        float: left;
    }


    .fixed_tools_div {
        position: fixed;
        left: 0;
        bottom: 0;
    }

    .fixed_tools_div > .btn, .datagrid-top-div > .btn {
        margin-left: 1em;
    }

    .container {

    }

    .cell_img {
        max-width: 200px;
        max-height: 100px;
    }

    .cell_content {
        position: relative;
        line-height: 1.4em;
        /* 3 times the line-height to show 3 lines */
        max-height: 5em;
        overflow: hidden;
    }
</style>


<footer class="footer">
    <div class="container">
        <p class="pull-left">#</p>

        <p class="pull-right">Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></p>
    </div>
</footer>


</body>
</html>
