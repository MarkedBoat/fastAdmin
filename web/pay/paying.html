<!--
 * @Author: 马国彬 1329336048@qq.com
 * @Date: 2022-09-07 09:05:48
 * @LastEditors: 马国彬 1329336048@qq.com
 * @LastEditTime: 2022-09-13 16:30:38
 * @FilePath: \bee-invasion-back-end\web\pay\paying.html
 * @Description: 这是默认设置,请设置`customMade`, 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE 
-->
<!DOCTYPE html>
<html lang="cn">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
  <title>待支付</title>
  <style>


  </style>
</head>

<body style="margin:0;">

  <div>


    <div style="    background: #f2f2f2;
    height: 80px;
    line-height: 80px;display: flex;justify-content: left;" id="back">
      <div style="width:10%;">
        <span style="    font-weight: bolder;
        font-size: 12px;
        margin-left: 10px;
        color: #333333;"> 返回 </span>
      </div>
      <div style=" 
      width: 80%;
      text-align: center;font-size: 15px;">支付订单</div>
    </div>

    <div id="pay" style="display: block;">
      <div style="width:100%;font-size: 16px;">
        <div style="text-align: center;    margin-top: 70px;color:#666666">实付款</div>
        <div style="text-align: center;font-weight: bolder;font-size: 24px;">￥<span style="font-size: 30px;"
            id="order_sum"> </span>
        </div>
        <div style="padding: 10px;">
          <div style="margin-top: 60px;">订单描述</div>
          <div style="margin-top:10px;font-size:14px;color:#666666" id="detail">
          </div>
        </div>


        <div>
          <div style="height: 50px;padding: 10px;
        line-height: 50px;display: flex;justify-content: space-between;margin-top:40px;">
            <div>
              <img src="../../../../../static/file/image/aliPay.png" style="width: 26px;vertical-align: middle;"> </img>
              <span style="font-size:14px;">支付宝</span>
            </div>
            <input type="radio" name="type" value='1' checked style="    width: 24px;  height: 100%;">
          </div>
        </div>
      </div>
      <div style="margin: 0 auto;
    text-align: center;
    left: 14%;
    margin-top: 40px;">
        <button class="default" style="width: 80%;
      height: 40px;
      background-color: #1777FF;
      border: 0;
      color: white;
      font-size: 20px;
      border-radius: 20px;" id="sure"> <a id="alipay_app" style="width: 100%;
      display: inline-block;text-decoration: none;color:#fff;">立即支付</a> </button>
      </div>
    </div>
    <div id="payYet" style="display: none;">
      <div style="margin:0 auto;margin-top:100px;">
        <div style="width: 70px;
        height: 70px;margin: 0 auto;
        border-radius: 50%;
        text-align: center;
        background-color: #1a76ff;
        line-height: 70px;">
          <img src="../../../../../static/file/image/goPay.png" style="width: 26px;vertical-align: middle;"> </img>
        </div>
      </div>
      <div style="text-align:center;font-size:20px;font-weight: bolder;margin-top:20px;">
        支付中 请耐心等待
      </div>
      <div style="text-align:center;font-size:18px;">
        倒计时 <span id="daojishi">30</span>s
      </div>

      <div style="margin: 0 auto;
      text-align: center;
      left: 14%;
      margin-top: 40px;display: flex;justify-content: center;">
        <button class="default" style="width:40%;
        height: 40px;
        background-color: #1777FF;
        border: 0;
        color: white;
        font-size: 20px;
        border-radius: 20px;" id="wancheng"> <a style="width: 100%;
        display: inline-block;text-decoration: none;color:#fff;">确认完成</a> </button>
        <button class="default" style="width: 40%;margin-left:10px;border:1px solid #1777FF;
         height: 40px;
         background-color: white; 
         color: #1777FF;
         font-size: 20px;
         border-radius: 20px;" id="quxiao"> <a style="width: 100%;
         display: inline-block;text-decoration: none;color:#1777FF;">取消支付</a> </button>
      </div>
    </div>


</body>
<script>

  let ran = navigator.userAgent
  let isAndroid = ran.indexOf('Android') > -1 || ran.indexOf('Linux') > -1
  let isIOS = !!ran.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)



  function insertStr(source, start, newStr) {
    return source.slice(0, -start) + newStr + source.slice(start)
  }


  function Ajax(type, url, data) {
    return new Promise(function (resolve, reject) {
      let ajax = new XMLHttpRequest();
      ajax.timeout = 3000
      if (type === 'get') {
        let params = ''
        Object.keys(data).forEach(function (key) {
          params += '&' + key + '=' + data[key]
        })
        params = params.replace('&', '?')
        ajax.open(type, url + params, true)
        ajax.send()
      } else {
        ajax.open(type, url, true)
        ajax.setRequestHeader('content-type', 'application/json')
        ajax.send(JSON.stringify(data))
      }
      ajax.ontimeout = function (e) {
        // XMLHttpRequest 超时。在此做某事。
        reject('请求超时，请稍后再试!')
      };
      ajax.onreadystatechange = function () {
        if (ajax.readyState === 4) {
          let ajaxStatus = ajax.status
          if (ajaxStatus !== 200) {
            reject('请求失败，请稍后再试!')
          } else {
            resolve(ajax.responseText)
          }
        }
      }
    })
  }

  function back() {
    if (isAndroid) {
      // 安卓代码块
      aizhilian.goBeeInvasion();
    }
    if (isIOS) {
      // ios代码块
      window.webkit.messageHandlers.feedBack.postMessage(null);
    }
  }

  console.log("serverData", serverData)

  if (serverData.alipay_app) {
    try {
      let data = JSON.parse(serverData.order_info)
      function search() {
        Ajax('get', data.query_url, {}).then(res => {
          let data = JSON.parse(res)
          if (data.data.is_payed == "yes") {
            back();
          }
        })
      }

      var timestart = 30;
      var timestep = -1;
      var timeID;
      function timecount() {
        document.getElementById("daojishi").innerHTML = timestart;
        timestart += timestep;
        if (timestart < 0) {
          timestart = 30;
          back();
        }
        if (timestart % 5 == 0) {
          try {
            search();
          } catch (error) {
          }
        }
        timeID = setTimeout("timecount()", 1000);
      }

      let order_sum = data.order_sum
      document.getElementById('order_sum').textContent = order_sum / 100;
      document.getElementById('detail').textContent = data.detail + '';

      console.log(" data.order_sum", data.order_sum)
      document.getElementById('wancheng').addEventListener('click', function () {
        if (isIOS) {
          window.webkit.messageHandlers.feedBack.postMessage('paySuccess');
        }
        else {
          back();
        }
      })
      document.getElementById('quxiao').addEventListener('click', function () {
        back();
      })
      document.getElementById('back').addEventListener('click', function () {
        back();
      })

      document.getElementById('sure').addEventListener('click', function () {
        if (isIOS) {
          window.webkit.messageHandlers.beeInvasionAliPayGoPay.postMessage('alipays://platformapi/startapp?saId=10000007&qrcode=' + serverData.alipay_app);
        }
        // else {
        //   window.open('alipays://platformapi/startapp?saId=10000007&qrcode=' + serverData.alipay_app)
        // }
        timecount();
        document.getElementById('pay').style.display = "none"
        document.getElementById('payYet').style.display = "block"
      })
      // document.getElementById('order_info').textContent = JSON.stringify(JSON.parse(serverData.order_info), null, 4);
    } catch (e) {

    }
  } else {
    alert('信息不全');
  }

  if (serverData.alipay_app) {
    // console.log(" document.getElementById('alipay_app')", document.getElementById('alipay_app'))
    // document.getElementById('alipay_app').onclick = `javascript:openURL('${encodeURIComponent('alipays://platformapi/startapp?saId=10000007&qrcode=' + serverData.alipay_app)}');`;
    document.getElementById('alipay_app').href = 'alipays://platformapi/startapp?saId=10000007&qrcode=' + serverData.alipay_app;

  } else {
    alert('信息不全');
  }
</script>

</html>