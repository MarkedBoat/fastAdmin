<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>【管理所有表】</title>
    <link href="/static/file/admin/css/bootstrap.css" rel="stylesheet">
    <link href="/static/file/admin/css/site.css" rel="stylesheet">
    <link href="/static/file/admin/css/bg.css" rel="stylesheet">

</head>
<body>
<div class="wrap">
    <nav id="w0" class="navbar-inverse navbar-fixed-top navbar">
        <div class="container">
            <div class="navbar-header"></div>
            <div id="bg_menus_div" class="navbar-brand menus_root">导航</div>
            <div id="w0-collapse" class="collapse navbar-collapse">
                <ul id="w1" class="navbar-nav navbar-right nav">
                    <li><a href="/admin/dbdata/tables.html">所有表</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <script src="/static/file/admin/js/hammer/kl-hammer.js"></script>
        <script src="/static/file/admin/js/string/string.js"></script>
        <script src="/static/file/admin/js/hammer-yii2/datagrid/datagrid.min.20211020.1.js"></script>
        <script src="/static/file/admin/js/bg.js"></script>

        <div class="site-index">

            <div>

            </div>


            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="page-header" id="user_nickname">【管理所有表】</h3>
                    <button><a id="import_all_table_link" href="/bee_invasion/v1/admin/dbdata/fillAllTable?">导入所有表</a></button>
                </div>
                <div class="panel-body">
                    <p id="subject_detail"></p>
                </div>
            </div>


            <div class="body-content" id="content_div">


            </div>

        </div>
        <script>
            domLoaded(function () {
                    let utk = '';
                    bg_init(function () {
                        utk = window.utk;
                        content();
                    });
                    let content = function () {

                        kl.id('import_all_table_link').href += '&user_token=' + utk;
                        var raw_root = kl.id('content_div');
                        var root = new Emt('div').setPros({className: 'row'});
                        raw_root.append(root);

                        let hanndle_datagrid = hammerBootstarpDatagrid({
                            ele: kl.id('content_div'),
                            preCondtion: serverData.preCondtion || {},
                            requestDataFun: function (event_type, page_data, handle_callback) {
                                console.log(event_type, page_data);
                                if (event_type === 'filter') {
                                    console.log('这个不做理会，不然请求太频繁了');
                                    return false;
                                }
                                let post_data = {
                                    //'_csrf-backend': serverData.csrf,
                                    page_index: page_data.page.index,
                                    page_size: page_data.page.size,
                                    attr: page_data.filter,
                                    // sort: page_data.sort,
                                    table_name: 'bi_bg_db_table',
                                };
                                for (let attr_key in post_data.attr) {
                                    console.log(attr_key);
                                    if (post_data.attr[attr_key][0] === ':') {
                                        post_data.attr[attr_key] = 'like:%' + post_data.attr[attr_key].substring(1) + '%';
                                    }
                                }
                                if (!page_data.sort.key || !page_data.sort.type) {
                                    console.log('没有排序');
                                } else {
                                    // post_data.sort = page_data.sort;
                                    post_data.sort = {};
                                    post_data.sort[page_data.sort.key] = page_data.sort.type;
                                }

                                if (0) {
                                    if (event_type !== 'init') {//只是写个例子，用于直接跳转，而非ajax
                                        let param_list = [];
                                        kl.data2list(param_list, post_data, 0, '');
                                        console.log(param_list);
                                        document.location = '/bee_invasion/v1/admin/dbdata/select?user_token=' + utk + '&' + param_list.map(function (info) {
                                            return info.val.length > 0 ? (info.key + '=' + info.val) : '';
                                        }).filter(function (str) {
                                            return str.length > 0;
                                        }).join('&');
                                        return false;
                                    }
                                }

                                kl.ajax({
                                    url: '/bee_invasion/v1/admin/dbdata/select?user_token=' + utk,
                                    data: post_data,
                                    type: 'json',
                                    method: 'POST',
                                    success: function (res_request_data) {
                                        if (res_request_data.status) {
                                            if (res_request_data.status === 200) {
                                                handle_callback(res_request_data.data.dataRows);
                                            } else {
                                                alert('查询数据错误:' + (res_request_data.message || '未知'))
                                            }
                                        } else {
                                            console.log(res_request_data.status);
                                            alert('请求结果异常')
                                        }
                                    },
                                    error: function (res_request_data) {
                                        console.log(res_request_data);
                                        alert('网络异常');
                                    }
                                })
                            },
                        });
                        let i = 0;
                        hanndle_datagrid.addHeader(hanndle_datagrid.createSpan(), '总计行数', 'test', true, function (cell, row_data) {
                            i++;
                            cell.textContent = i.toString();
                        });

                        hanndle_datagrid.addHeader(hanndle_datagrid.createInputText(), 'id', 'id', true);
                        hanndle_datagrid.addHeader(hanndle_datagrid.createInputText(), '标题', 'title', true);
                        hanndle_datagrid.addHeader(hanndle_datagrid.createInputText(), 'db_name', 'db_name', true);
                        hanndle_datagrid.addHeader(hanndle_datagrid.createInputText(), 'table_name', 'table_name', true);
                        hanndle_datagrid.addHeader(hanndle_datagrid.createInputText(), '创建时间', 'create_time', true);

                        hanndle_datagrid.addHeader(new Emt('span').setAttrsByStr('', '#'), '操作', 'op', true, function (cell, row_data) {
                            let btn_import_column = new Emt('button', 'class="btn btn-warning btn-sm"').setPros({textContent: '导入字段'});

                            btn_import_column.addEventListener('click', function () {
                                kl.ajax({
                                    // url: 'http://back.markedboat.com/dbdata/fill_table?db=' + row_data.db_name + '&table=' + row_data.table_name,
                                    url: '/bee_invasion/v1/admin/dbdata/fillColumn?user_token=' + utk + '&table=' + row_data.table_name,
                                    method: 'GET',
                                    type: 'text',
                                    success: function (res_import_columns) {
                                        if (res_import_columns.indexOf('SUCCESS')) {
                                            alert('导入字段成功');
                                        } else {
                                            alert('导入字段 请求结果异常')
                                        }
                                    },
                                    error: function (res_import_columns) {
                                        console.log(res_import_columns);
                                        alert('导入字段 网络异常');
                                    }
                                })
                            });
                            let tmp_info = {table_name: row_data.table_name};
                            let tmp_json = JSON.stringify(tmp_info).urlencode();
                            console.log(tmp_info, tmp_json);
                            let a_column = new Emt('a').setPros({className: 'btn btn-info btn-sm', href: '/admin/dbdata/columns_adv.html?' + tmp_json, target: '_blank', textContent: 'go管理字段'});
                            let a_select = new Emt('a').setPros({className: 'btn btn-info btn-sm', href: '/admin/dbdata/select_adv.html?' + tmp_json, target: '_blank', textContent: 'go查询数据-表'});
                            let a_orm = new Emt('a').setPros({className: 'btn btn-info btn-sm', href: '/dev/v1/mysql/orm?conf=dev&table=' + row_data.table_name, target: '_blank', textContent: 'ORM'});
                            cell.addNodes([btn_import_column, a_column, a_select, a_orm]);
                        });


                        // serverData.tables.forEach(function (row) {
                        //     hanndle_datagrid.addDataRow(row);
                        // });
                        hanndle_datagrid.requestData('init');

                        if (0) {
                            setTimeout(function () {
                                console.log(1);

                                hanndle_datagrid.clearDataRows();
                                serverData.tables.forEach(function (row) {
                                    hanndle_datagrid.addDataRow(row);
                                });
                                serverData.tables.forEach(function (row) {
                                    hanndle_datagrid.addDataRow(row);
                                });

                                setTimeout(function () {
                                    console.log(2);
                                    hanndle_datagrid.clearDataRows();
                                    serverData.tables.forEach(function (row) {
                                        hanndle_datagrid.addDataRow(row);
                                    });
                                }, 5000)


                            }, 5000)
                        }


                    }
                }
            );
        </script>
        <style>
            .container {
                width: 100% !important;
            }

            .hide_btn_sort_asc > .btn_sort_asc {
                display: none;
            }

            .hide_btn_sort_desc > .btn_sort_desc {
                display: none;
            }

            .hide_btn_sort > .btn_sort_asc, .hide_btn_sort > .btn_sort_desc {
                display: none;
            }

            .table > thead > tr > th, .table > tbody > tr > th, .table > tfoot > tr > th, .table > thead > tr > td, .table > tbody > tr > td, .table > tfoot > tr > td {
                padding: 3px !important;

            }

            td > input[type="text"], td > input[type="number"], td > select {
                min-width: 45px !important;
                padding: 0 !important;
            }
        </style>
        <script>serverData = {
            "user": {
                "id": 7,
                "nickname": "\u5357\u67ef\u592a\u5b88",
                "avatar": "http:\/\/q.qlogo.cn\/qqapp\/101319400\/05A814DB0159CD4A68A5C2C30BDA44B3\/100",
                "rbac_tasks": [{"task_name": "\u8bdd\u9898\u4e00\u822c\u7ba1\u7406", "task_code": "qa_subject_add"}, {"task_name": "\u89c6\u9891\u8bfb\u5199", "task_code": "video_rw"}],
                "rbac_task_codes": ["qa_subject_add", "video_rw"],
                "rbac_role_codes": ["admin", "qa_subject_add", "video_rw", "backend_admin", "da_data_admin", "mark_admin", "mark_adder", "all_data_viewer"],
                "rbac_roles": [{"id": "1", "role_name": "\u8d85\u7ea7\u7ba1\u7406\u5458", "role_code": "admin"}, {"id": "2", "role_name": "\u8bdd\u9898\u4e00\u822c\u7ba1\u7406", "role_code": "qa_subject_add"}, {
                    "id": "3",
                    "role_name": "\u89c6\u9891\u4e00\u822c\u8bfb\u5199",
                    "role_code": "video_rw"
                }, {"id": "4", "role_name": "\u540e\u53f0\u7ba1\u7406\u5458", "role_code": "backend_admin"}, {"id": "5", "role_name": "\u6570\u636e\u7ba1\u7406\u5458", "role_code": "da_data_admin"}, {
                    "id": "7",
                    "role_name": "\u6587\u7ae0\u7ba1\u7406\u5458",
                    "role_code": "mark_admin"
                }, {"id": "8", "role_name": "\u6587\u7ae0\u64b0\u5199", "role_code": "mark_adder"}, {"id": "9", "role_name": "\u67e5\u770b\u6240\u6709\u6570\u636e", "role_code": "all_data_viewer"}],
                "role_codes": ["admin", "qa_subject_add", "video_rw", "backend_admin", "da_data_admin", "mark_admin", "mark_adder", "all_data_viewer"]
            }, "csrf": "e4wIR_nnZmZ8EQ1vU_2L_oBtnCFNCMpIp-XOVSHXETs3_lsFt4VVMz13NSgEtM3TuALqdxV5mxzIgacfFZxgVQ==", "classname": "common\\models\\dbdata\\KzDbdataTable", "preCondtion": {"attrs": [], "sort": []}
        };</script>
    </div>
</div>


<footer class="footer">
    <div class="container">
        <p class="pull-left">&copy; My Company 2022</p>

        <p class="pull-right">Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></p>
    </div>
</footer>

<script src="/static/file/admin/js/jquery.js"></script>
<script src="/static/file/admin/js/bootstrap.js"></script>
</body>
</html>
