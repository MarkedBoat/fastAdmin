<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>表字段</title>
    <link href="/static/file/admin/css/bootstrap.css" rel="stylesheet">
    <link href="/static/file/admin/css/site.css" rel="stylesheet">
    <link href="/static/file/admin/css/bg.css" rel="stylesheet">
</head>
<body>
<div class="wrap">
    <nav id="w0" class="navbar-inverse navbar-fixed-top navbar">
        <div class="container">
            <div class="navbar-header"></div>
            <div id="bg_menus_div" class="navbar-brand menus_root">导航</div>
            <div id="w0-collapse" class="collapse navbar-collapse">
                <ul id="w1" class="navbar-nav navbar-right nav">
                    <li><a href="/admin/dbdata/tables.html">所有表</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <script src="/static/file/admin/js/hammer/kl-hammer.js"></script>
        <script src="/static/file/admin/js/string/string.js"></script>
        <script src="/static/file/admin/js/hammer-yii2/bootstrap.min.2022.10.07.0.js"></script>
        <script src="/static/file/admin/js/hammer-yii2/datagrid/datagrid.min.2022.11.16.js"></script>
        <script src="/static/file/admin/js/bg.js"></script>

        <div class="site-index">

            <div>

            </div>


            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="page-header" id="h1">【管理-字段】</h3>
                </div>
                <div class="panel-body">
                    <p id="subject_detail"></p>
                </div>
            </div>


            <div class="body-content" id="content_div">


            </div>

        </div>
        <script>
            domLoaded(function () {
                    let utk = '';
                    let rbac_role_tableName = 'bg_rbac_role';
                    let dbdata_column_tableName = 'bg_db_column';

                    let role_infos = [];
                    bg_init(function () {
                        utk = window.utk;

                        window.serverData.dataLib = {
                            admin: {items: [], list: [], map: {}},
                            role: {items: [], list: [], map: {}},
                            mainTable: {},
                            dbdataColumnTable: {}

                        };

                        let getRoles = (fun) => {
                            kl.ajax({
                                url: '/dp/v1/admin/dbdata/select?user_token=' + utk,
                                data: {table_name: rbac_role_tableName, page_index: 1, page_size: 1000},
                                type: 'json',
                                success: function (res_request_data) {
                                    if (kl.isUndefined(res_request_data, 'data.dataRows') || typeof res_request_data.data.dataRows.forEach !== "function") {
                                        alert('获取菜单列表:结构异常' + res_request_data.msg || '');

                                    } else {
                                        window.serverData.dataLib.role.list = res_request_data.data.dataRows;
                                        window.serverData.dataLib.role.list.forEach((roleInfo) => {
                                            window.serverData.dataLib.role.items.push({val: roleInfo.id, text: roleInfo.role_name});
                                            window.serverData.dataLib.role.map[roleInfo.id] = roleInfo.real_name;
                                        });
                                        fun();
                                    }
                                },
                                error: function (res_request_data) {
                                    alert('获取菜单列表:网络错误' + res_request_data);
                                }
                            });
                        };
                        let getDbdataColumnTableInfo = (fun) => {
                            kl.ajax({
                                url: '/dp/v1/admin/dbdata/info?user_token=' + utk,
                                data: {table_name: dbdata_column_tableName},
                                type: 'json',
                                success: function (res_request_data) {
                                    if (res_request_data.status) {
                                        if (kl.isUndefined(res_request_data, 'data.columns') || kl.isUndefined(res_request_data, 'data.table')) {
                                            alert(' 获取表信息 错误:' + (res_request_data.message || '未知'));
                                            throw '别看了，连table info 信息都拿不到，还想干啥?';
                                        } else {
                                            window.serverData.dataLib.dbdataColumnTable = {
                                                __column: {map: {}, items: res_request_data.data.columns},
                                                linkType: {map: {}, items: []},
                                                isOk: {map: {}, items: []},
                                            };
                                            res_request_data.data.columns.forEach(function (colInfo) {
                                                window.serverData.dataLib.dbdataColumnTable.__column.map[colInfo.column_name] = colInfo;
                                            });
                                            window.serverData.dataLib.dbdataColumnTable.isOk.items = window.serverData.dataLib.dbdataColumnTable.__column.map.is_ok.val_range;
                                            window.serverData.dataLib.dbdataColumnTable.isOk.items.forEach(function (itemInfo) {
                                                window.serverData.dataLib.dbdataColumnTable.isOk.map[itemInfo.val] = itemInfo.text;
                                            });
                                            fun();
                                        }
                                    } else {
                                        console.log(res_request_data.status);
                                        alert('获取表信息 请求结果异常');
                                        throw '别看了， info 信息都拿不到，还想干啥?';
                                    }
                                },
                                error: function (res_request_data) {
                                    console.log(res_request_data);
                                    alert('获取表信息 网络异常');
                                    throw '别看了，连table info 信息都拿不到，还想干啥?';

                                }
                            });

                        };
                        let getMainTableInfo = (fun) => {
                            kl.ajax({
                                url: '/dp/v1/admin/dbdata/info?user_token=' + utk,
                                data: {table_name: window.serverData.table_name},
                                type: 'json',
                                success: function (res_request_data) {
                                    if (res_request_data.status) {
                                        if (kl.isUndefined(res_request_data, 'data.columns') || kl.isUndefined(res_request_data, 'data.table')) {
                                            alert(' 获取表信息 错误:' + (res_request_data.message || '未知'));
                                            throw '别看了，连table info 信息都拿不到，还想干啥?';
                                        } else {
                                            window.serverData.dataLib.mainTable = {
                                                __column: {map: {}, items: res_request_data.data.columns},
                                                linkType: {map: {}, items: []},
                                                isOk: {map: {}, items: []},
                                                table: res_request_data.data.table
                                            };
                                            res_request_data.data.columns.forEach(function (colInfo) {
                                                window.serverData.dataLib.mainTable.__column.map[colInfo.column_name] = colInfo;
                                            });
                                            // window.serverData.dataLib.mainTable.linkType.items = window.serverData.dataLib.mainTable.__column.map.is_backend.val_range;
                                            // window.serverData.dataLib.mainTable.linkType.items.forEach(function (itemInfo) {
                                            //     window.serverData.dataLib.mainTable.linkType.map[itemInfo.val] = itemInfo.text;
                                            // });
                                            //
                                            // window.serverData.dataLib.mainTable.isOk.items = window.serverData.dataLib.mainTable.__column.map.is_ok.val_range;
                                            // window.serverData.dataLib.mainTable.isOk.items.forEach(function (itemInfo) {
                                            //     window.serverData.dataLib.mainTable.isOk.map[itemInfo.val] = itemInfo.text;
                                            // });
                                            fun();
                                        }
                                    } else {
                                        console.log(res_request_data.status);
                                        alert('获取表信息 请求结果异常');
                                        throw '别看了，连table info 信息都拿不到，还想干啥?';
                                    }
                                },
                                error: function (res_request_data) {
                                    console.log(res_request_data);
                                    alert('获取表信息 网络异常');
                                    throw '别看了，连table info 信息都拿不到，还想干啥?';

                                }
                            });
                        };

                        getRoles(() => {
                            getDbdataColumnTableInfo(() => {
                                getMainTableInfo(() => {
                                    content();
                                })
                            })
                        })
                    });


                    content = function () {
                        kl.id('h1').textContent = kl.id('h1').textContent + '/' + window.serverData.dataLib.mainTable.table.title + '/ ' + window.serverData.table_name;
                        document.title = '【列】' + window.serverData.dataLib.mainTable.table.title + '/' + serverData.table.table_name;


                        let rolesTable = () => {
                            let role_table = new Emt('table').setAttrsByStr('class="table table-bordered table-striped table-hover"');
                            let role_table_header = role_table.createTHead();
                            let role_tr_header = role_table_header.insertRow();
                            role_tr_header.insertCell().textContent = '角色';
                            role_tr_header.insertCell().textContent = '读';
                            role_tr_header.insertCell().textContent = '改(选写)';
                            role_tr_header.insertCell().textContent = '增/删';
                            let role_table_body = role_table.createTBody();

                            role_table.col_read_role_checkboxs = [];
                            role_table.col_opt_role_checkboxs = [];
                            role_table.col_add_role_checkboxs = [];

                            window.serverData.dataLib.role.list.forEach(function (roleInfo) {
                                let body_tr = role_table_body.insertRow();
                                body_tr.role_td = body_tr.insertCell();
                                body_tr.read_td = body_tr.insertCell();
                                body_tr.opts_td = body_tr.insertCell();
                                body_tr.add_td = body_tr.insertCell();
                                body_tr.role_td.textContent = roleInfo.role_name;
                                body_tr.read_role_checkbox = new Emt('input', 'type="checkbox"', '', {value: roleInfo.role_code});
                                body_tr.read_opt_checkbox = new Emt('input', 'type="checkbox"', '', {value: roleInfo.role_code});
                                body_tr.read_add_checkbox = new Emt('input', 'type="checkbox"', '', {value: roleInfo.role_code});
                                role_table.col_read_role_checkboxs.push(body_tr.read_role_checkbox);
                                role_table.col_opt_role_checkboxs.push(body_tr.read_opt_checkbox);
                                role_table.col_add_role_checkboxs.push(body_tr.read_add_checkbox);
                                body_tr.read_td.append(new Emt('label', '', '#').addNodes([body_tr.read_role_checkbox, new Emt('span', '', '#')]));
                                body_tr.opts_td.append(new Emt('label', '', '#').addNodes([body_tr.read_opt_checkbox, new Emt('span', '', '#')]));
                                body_tr.add_td.append(new Emt('label', '', '#').addNodes([body_tr.read_add_checkbox, new Emt('span', '', '#')]));

                            });
                            role_table.loadColumnsRoles = (dataRow) => {
                                role_table.col_read_role_checkboxs.forEach((checkbox) => {
                                    checkbox.checked = dataRow.read_roles.indexOf(checkbox.value) > -1;
                                });
                                role_table.col_opt_role_checkboxs.forEach((checkbox) => {
                                    checkbox.checked = dataRow.opt_roles.indexOf(checkbox.value) > -1;
                                });
                                role_table.col_add_role_checkboxs.forEach((checkbox) => {
                                    checkbox.checked = dataRow.add_roles.indexOf(checkbox.value) > -1;
                                });
                            };
                            role_table.getRoleCodes = () => {
                                let res = {read: [], opt: [], add: []};
                                role_table.col_read_role_checkboxs.forEach((checkbox) => {
                                    if (checkbox.checked) {
                                        res.read.push(checkbox.value);
                                    }
                                });
                                role_table.col_opt_role_checkboxs.forEach((checkbox) => {
                                    if (checkbox.checked) {
                                        res.opt.push(checkbox.value);
                                    }
                                });
                                role_table.col_add_role_checkboxs.forEach((checkbox) => {
                                    if (checkbox.checked) {
                                        res.add.push(checkbox.value);
                                    }
                                });
                                return res;
                            };
                            return role_table;
                        };
                        let createValueItemsTable = () => {
                            let items_table = new Emt('table').setAttrsByStr('class="table table-bordered table-striped table-hover"');
                            let ele_vals_submit_btn = new Emt('button', 'type="button"').setPros({textContent: '应用到取值范围'});
                            let tmp_table_header = items_table.createTHead();
                            let tmp_tr_header = tmp_table_header.insertRow();
                            tmp_tr_header.insertCell().textContent = '序号';
                            tmp_tr_header.insertCell().textContent = '值';
                            tmp_tr_header.insertCell().textContent = '标签/含义';
                            tmp_tr_header.insertCell().textContent = '启用';

                            items_table.TBody = items_table.createTBody();
                            items_table.apiHandle = {
                                trs: [],
                                acceptJsonInputElement: false
                            };
                            items_table.apiHandle.addItemRow = function (val_info) {
                                let item_tr = items_table.TBody.insertRow();
                                items_table.apiHandle.trs.push(item_tr);
                                item_tr.val_input = new Emt('input').setAttrsByStr('type="text"');
                                item_tr.text_input = new Emt('input').setAttrsByStr('type="text"');
                                item_tr.check_input = new Emt('input').setAttrsByStr('type="checkbox"');
                                item_tr.insertCell().textContent = items_table.apiHandle.trs.length.toString();
                                item_tr.insertCell().append(item_tr.val_input);
                                item_tr.insertCell().append(item_tr.text_input);
                                item_tr.insertCell().append(item_tr.check_input);
                                item_tr.loadInfo = (valItemInfo) => {
                                    item_tr.val_input.value = valItemInfo.val || '';
                                    item_tr.text_input.value = valItemInfo.text || '';
                                    item_tr.check_input.checked = true;
                                };
                                return item_tr;
                            };

                            let tmp_table_footer = items_table.createTFoot();

                            let tmp_tr_footer = tmp_table_footer.insertRow();
                            let add_val_setting_btn = new Emt('button', 'type="button"').setPros({textContent: '添加item'});
                            tmp_tr_footer.insertCell().textContent = '#';
                            //tmp_tr_footer.insertCell().textContent = '#';
                            tmp_tr_footer.insertCell().append(add_val_setting_btn);
                            tmp_tr_footer.insertCell().append(ele_vals_submit_btn);


                            ele_vals_submit_btn.addEventListener('click', function () {
                                if (items_table.apiHandle.acceptJsonInputElement === false) {
                                    console.log('没有设置 acceptJsonInputElement:', items_table.getItems());
                                } else {
                                    items_table.apiHandle.acceptJsonInputElement.value = JSON.stringify(items_table.getItems());
                                }
                            });
                            add_val_setting_btn.addEventListener('click', function () {
                                items_table.apiHandle.addItemRow().check_input.checked = true;
                            });
                            items_table.clearItems = () => {
                                items_table.TBody.innerHTML = '';
                                items_table.apiHandle.trs = [];
                                return items_table;
                            };
                            items_table.getItems = () => {
                                let items = [];
                                items_table.apiHandle.trs.forEach((tr) => {
                                    if (tr.check_input.checked === true) {
                                        items.push({
                                            val: tr.val_input.value,
                                            text: tr.text_input.value,
                                        });
                                    }
                                });
                                return items;
                            };
                            items_table.loadItems = (items) => {
                                items.forEach((itemInfo) => {
                                    items_table.apiHandle.addItemRow().loadInfo(itemInfo);
                                });
                            };
                            items_table.setAcceptJsonInputElement = (inputElement) => {
                                items_table.apiHandle.acceptJsonInputElement = inputElement;
                                return items_table;
                            };
                            return items_table;
                        };

                        var raw_root = kl.id('content_div');
                        var root = new Emt('div').setPros({className: 'row'});
                        raw_root.append(root);

                        let colums_vals_map = {
                            vals_limit: {1: '有限穷举', 2: '[yes,no]', 3: '无限,无法预料'},
                            yes_or_no: {1: '是', 2: '否'},
                        };


                        let hammerYii2Bootstarp1 = hammerYii2Bootstarp();
                        let modal_edit = hammerYii2Bootstarp1.createModal({title: '修改字段设置'});
                        let modal_vals = hammerYii2Bootstarp1.createModal({title: '编辑字段取值穷举'});
                        let form_edit = hammerYii2Bootstarp1.createForm({dataNameTpl: 'attr[$var]'});

                        modal_edit.apiHandle.ele.body.addNodes([form_edit]);
                        form_edit.apiHandle.addGroupPreCreate().setLabelText('字段').setIndexKey('column_name').create('text');
                        let column_name_input = form_edit.apiHandle.ele.input.column_name;

                        form_edit.apiHandle.addGroupPreCreate().setNameVar('id').setIndexKey('id').create('hide');
                        let column_id_input = form_edit.apiHandle.ele.input.id;

                        form_edit.apiHandle.addGroupPreCreate().setLabelText('字段标题').setPlaceHolder('用于当成label显示').setIndexKey('title').setNameVar('title').create('text');
                        let column_title_input = form_edit.apiHandle.ele.input.title;


                        form_edit.apiHandle.addGroupPreCreate().setLabelText('字段序号').setPlaceHolder('大->小').setIndexKey('sn').setNameVar('column_sn').create('number');
                        let column_sn_input = form_edit.apiHandle.ele.input.sn;


                        form_edit.apiHandle.addGroupPreCreate().setLabelText('字段描述').setPlaceHolder('备注').setIndexKey('remark').setNameVar('remark').create('textarea');
                        let column_remark_input = form_edit.apiHandle.ele.input.remark;


                        form_edit.apiHandle.addGroupPreCreate().setLabelText('取值范围').setPlaceHolder('代表值对应含义').setIndexKey('val_range').setNameVar('val_range').create('textarea');
                        let column_valRange_input = form_edit.apiHandle.ele.input.val_range;


                        let edit_vals_div = new Emt('div').setAttrsByStr('class="table-responsive"');

                        let tmp_group = hammerYii2Bootstarp1.createFormInputGroupDiv({});
                        tmp_group.apiHandle.setText('').apiHandle.addInputEle(edit_vals_div);
                        form_edit.addNode(tmp_group);
                        let valueRangeTable = createValueItemsTable();
                        edit_vals_div.addNodes([
                            new Emt('div').setAttrsByStr('class="table-responsive"').addNodes([valueRangeTable])
                        ]);
                        valueRangeTable.setAcceptJsonInputElement(column_valRange_input);


                        form_edit.apiHandle.addGroupPreCreate().setLabelText('输出类型').setIndexKey('out_datatype').setNameVar('out_datatype').setItems([
                            {text: 'string', val: 'string'},
                            {text: 'int', val: 'int'},
                            {text: 'date', val: 'date'},
                            {text: 'img_uri', val: 'img_uri'}
                        ]).create('select');
                        let column_outDataType_input = form_edit.apiHandle.ele.input.out_datatype;


                        form_edit.apiHandle.addGroupPreCreate().setLabelText('接收类型').setIndexKey('in_datatype').setNameVar('in_datatype').setItems([
                            {text: 'string', val: 'string'},
                            {text: 'int', val: 'int'},
                            {text: 'date', val: 'date'}
                        ]).create('select');
                        let column_inDataType_input = form_edit.apiHandle.ele.input.in_datatype;


                        let role_table = rolesTable();
                        let role_groupDiv = hammerYii2Bootstarp1.createFormInputGroupDiv({});
                        role_groupDiv.apiHandle.setText('权限控制').apiHandle.addInputEle(role_table);
                        form_edit.addNode(role_groupDiv);


                        //label, text, handle_ele_key, callback
                        form_edit.apiHandle.addGroupPreCreate().setType('button').setContentText('保存').setIndexKey('submit').setClickCall(function (btn) {
                            let rolecodes_map = role_table.getRoleCodes();

                            console.log(btn, this, form_edit.apiHandle, rolecodes_map);
                            //  return false;
                            kl.ajax({
                                url: '/dp/v1/admin/dbdata/update?user_token=' + utk,
                                //attr: form,
                                data: {
                                    attr: {
                                        id: form_edit.apiHandle.ele.input.id.apiHandle.getVal(),
                                        title: form_edit.apiHandle.ele.input.title.apiHandle.getVal(),
                                        column_sn: form_edit.apiHandle.ele.input.sn.apiHandle.getVal(),
                                        out_datatype: form_edit.apiHandle.ele.input.out_datatype.apiHandle.getVal(),
                                        in_datatype: form_edit.apiHandle.ele.input.in_datatype.apiHandle.getVal(),
                                        val_range: form_edit.apiHandle.ele.input.val_range.apiHandle.getVal(),
                                        remark: form_edit.apiHandle.ele.input.remark.apiHandle.getVal(),
                                        read_roles: JSON.stringify(rolecodes_map.read),
                                        opt_roles: JSON.stringify(rolecodes_map.opt),
                                        add_roles: JSON.stringify(rolecodes_map.add),
                                    },
                                    table_name: dbdata_column_tableName,
                                },
                                type: 'json',
                                success: function (res_save_column) {
                                    if (res_save_column.status) {
                                        if (res_save_column.status === 200) {
                                            datagrid.api.requestData('init');
                                            //res_save_column(res_save_column.data);
                                            modal_edit.apiHandle.hide();
                                        } else {
                                            alert('错误:' + (res_save_column.msg || '未知'))
                                        }
                                    } else {
                                        console.log(res_save_column);
                                        alert('请求结果异常')
                                    }
                                },
                                error: function (res_save_column) {
                                    console.log(res_save_column);
                                    alert('网络异常');
                                }
                            })
                        }).create('button');


                        let id_list = [];
                        let sort_bar_list = [];
                        let datagrid = hammerBootstarpDatagrid({});
                        console.log('datagrid', datagrid);
                        datagrid.api.setDstDivElement(kl.id('content_div'));
                        datagrid.api.setRequestDataRowsFunction(function (event_type, dataGrid) {
                            id_list = [];
                            sort_bar_list = [];
                            let page_data = dataGrid.api.getRequestParam();
                            console.log(event_type, page_data);
                            if (event_type === 'filter') {
                                console.log('这个不做理会，不然请求太频繁了');
                                return false;
                            }
                            let post_data = {
                                page: {index: 1, size: 1000},
                                attr: page_data.filter,
                                table_name: dbdata_column_tableName,
                            };
                            post_data.attr.table_name = window.serverData.table_name;

                            if (!page_data.sort.key || !page_data.sort.type) {
                                console.log('没有排序');
                            } else {
                                // post_data.sort = page_data.sort;
                                post_data.sort = {};
                                post_data.sort[page_data.sort.key] = page_data.sort.type;
                            }
                            kl.ajax({
                                url: '/dp/v1/admin/dbdata/select?user_token=' + utk,
                                data: post_data,
                                type: 'json',
                                success: function (res_request_data) {
                                    console.log('请求成功');
                                    if (res_request_data.status) {
                                        if (res_request_data.status === 200) {
                                            //handle_callback(res_request_data.data.dataRows);
                                            dataGrid.api.reloadDataRows(res_request_data.data);
                                        } else {
                                            alert('错误:' + (res_request_data.msg || '未知'))
                                        }
                                    } else {
                                        console.log(res_request_data.status);
                                        alert('请求结果异常')
                                    }
                                },
                                error: function (res_request_data) {
                                    console.log('datagrid.api.setRequestDataRowsFunction 网络异常:' + res_request_data);
                                    alert('网络异常');
                                }
                            });


                        });

                        datagrid.api.preCreateColumn('id').setColumnInfo({}).setHeaderText('ID').setSortable(true).setFixedFilterInputConfig({valueItems: []});

                        datagrid.api.preCreateColumn('column_sn').setColumnInfo({}).setHeaderText('字段序号').setSortable(true).setFixedFilterInputConfig({valueItems: []}).setRenderFunction((cell, row_data) => {
                            let input_data = datagrid.api.getRequestParam();
                            //                            console.log(input_data);
                            if (input_data.sort.key === 'column_sn' && input_data.sort.type === 'desc') {
                                id_list.push(parseInt(row_data.id));
                                let bar_btn = new Emt('button', 'type="button"', row_data.column_sn, {draggable: true, sn: parseInt(row_data.column_sn), data_id: parseInt(row_data.id)});
                                let pre_area = new Emt('div', '', '<--', {sn: parseInt(row_data.column_sn), data_id: parseInt(row_data.id)});
                                let next_area = new Emt('div', '', '-->', {sn: parseInt(row_data.column_sn), data_id: parseInt(row_data.id)});
                                sort_bar_list.push(bar_btn);
                                let tmp_div = new Emt('div', 'class="drag_sort_div"');
                                tmp_div.addNodes([pre_area, bar_btn, next_area]);
                                cell.appendChild(tmp_div);

                                bar_btn.addEventListener('dragstart', function (e) {
                                    console.log('dragstart', e.target);
                                    window.dragedEle = bar_btn;
                                });
                                bar_btn.addEventListener('drag', function (e) {
                                    //console.log('drag');

                                });
                                bar_btn.addEventListener('dragend', function (e) {
                                    console.log('dragend');
                                    window.dragedEle = false;
                                });

                                pre_area.addEventListener('dragenter', function (e) {
                                    //console.log('dragenter');
                                });
                                pre_area.addEventListener('drop', function (e) {
                                    let tmp_index = id_list.indexOf(pre_area.data_id);
                                    let tmp_ar = [];
                                    if (tmp_index === 0) {
                                        tmp_ar.push(window.dragedEle.data_id);
                                    }
                                    id_list.forEach((data_id) => {
                                        if (window.dragedEle.data_id !== data_id) {
                                            tmp_ar.push(data_id);
                                        }
                                    });
                                    console.log('PRE drop', pre_area, pre_area.data_id, window.dragedEle, window.dragedEle.data_id, tmp_ar);

                                    kl.ajax({
                                        url: '/dp/v1/admin/dbdata/sortColumn?user_token=' + utk,
                                        data: {
                                            ids: tmp_ar
                                        },
                                        type: 'json',
                                        success: function (tmp_res) {
                                            datagrid.api.requestData('init');
                                        },
                                        error: function (res_save_column) {
                                            alert('报错了');
                                        }
                                    })

                                });
                                pre_area.addEventListener('dragover', function (e) {
                                    // console.log('dragover');
                                    e.preventDefault(); //【重要】一定要加这一行代码，否则，后面的方法 ondrop() 无法触发。

                                });
                                pre_area.addEventListener('dragleave', function (e) {
                                    //console.log('dragleave');
                                });


                                next_area.addEventListener('dragenter', function (e) {
                                    //console.log('dragenter');
                                });
                                next_area.addEventListener('drop', function (e) {
                                    let tmp_ar = [];
                                    id_list.forEach((data_id, index) => {
                                        if (data_id !== window.dragedEle.data_id) {
                                            if (data_id === next_area.data_id) {
                                                tmp_ar.push(data_id);
                                                tmp_ar.push(window.dragedEle.data_id);
                                            } else {
                                                tmp_ar.push(data_id);
                                            }
                                        }
                                    });
                                    console.log('NEXT drop', pre_area, pre_area.data_id, window.dragedEle, window.dragedEle.data_id, tmp_ar);
                                    kl.ajax({
                                        url: '/dp/v1/admin/dbdata/sortColumn?user_token=' + utk,
                                        data: {
                                            ids: tmp_ar
                                        },
                                        type: 'json',
                                        success: function (tmp_res) {
                                            datagrid.api.requestData('init');
                                        },
                                        error: function (res_save_column) {
                                            alert('报错了');
                                        }
                                    })

                                });
                                next_area.addEventListener('dragover', function (e) {
                                    // console.log('dragover');
                                    e.preventDefault(); //【重要】一定要加这一行代码，否则，后面的方法 ondrop() 无法触发。

                                });
                                next_area.addEventListener('dragleave', function (e) {
                                    //console.log('dragleave');
                                });

                            } else {
                                cell.textContent = row_data.column_sn;
                            }


                        });
                        datagrid.api.preCreateColumn('title').setColumnInfo({}).setHeaderText('标题').setSortable(true).setFixedFilterInputConfig({valueItems: []});
                        datagrid.api.preCreateColumn('table_name').setColumnInfo({}).setHeaderText('表名').setSortable(true).setFixedFilterInputConfig({valueItems: []});

                        datagrid.api.preCreateColumn('column_name').setColumnInfo({}).setHeaderText('列字段名').setSortable(true).setFixedFilterInputConfig({valueItems: []});

                        datagrid.api.preCreateColumn('data_type').setColumnInfo({}).setHeaderText('类型').setSortable(true).setFixedFilterInputConfig({valueItems: []}).setRenderFunction((cell, row_data) => {
                            cell.textContent = row_data.db_datatype + '(' + row_data.db_datatype_len.toString() + '])';
                        });

                        datagrid.api.preCreateColumn('in_datatype').setColumnInfo({}).setHeaderText('接收类型').setSortable(true).setFixedFilterInputConfig({valueItems: []}).setRenderFunction((cell, row_data) => {
                            cell.textContent = row_data.in_datatype;
                        });
                        datagrid.api.preCreateColumn('out_datatype').setColumnInfo({}).setHeaderText('展示类型').setSortable(true).setFixedFilterInputConfig({valueItems: []}).setRenderFunction((cell, row_data) => {
                            cell.textContent = row_data.out_datatype;
                        });

                        datagrid.api.preCreateColumn('val_range').setColumnInfo({}).setHeaderText('字段值范围').setSortable(true).setFixedFilterInputConfig({valueItems: []}).setRenderFunction((cell, row_data) => {
                            let tmp_pre = new Emt('pre');
                            console.log(row_data.column_name);
                            if (0) {
                                if (window.serverData.vals_range_map[row_data.column_name] !== undefined && window.serverData.vals_range_map[row_data.column_name].length) {
                                    let tmp_strs = [];
                                    window.serverData.vals_range_map[row_data.column_name].forEach(function (val_opt_info) {
                                        tmp_strs.push(JSON.stringify(val_opt_info));
                                    });
                                    tmp_pre.textContent = tmp_strs.join("\n");
                                    tmp_pre.textContent = JSON.stringify(window.serverData.vals_map[row_data.column_name], null, 2);
                                } else {
                                    tmp_pre.textContent = '自由定义';
                                }
                            } else {
                                if (row_data.val_range !== undefined && row_data.val_range !== null && row_data.val_range.length && row_data.val_range !== '[]') {
                                    let tmp_val_range = JSON.parse(row_data.val_range);
                                    console.log(row_data.val_range, typeof row_data.val_range);
                                    let tmp_strs = [];
                                    tmp_val_range.forEach(function (val_opt_info) {
                                        tmp_strs.push(JSON.stringify(val_opt_info));
                                    });
                                    tmp_pre.textContent = tmp_strs.join("\n");
                                    //  tmp_pre.textContent = JSON.stringify(tmp_strs, null, 2);
                                } else {
                                    tmp_pre.textContent = '自由定义';
                                }
                            }
                            cell.addNodes([
                                tmp_pre
                            ]);

                        });


                        datagrid.api.preCreateColumn('is_ok').setColumnInfo({}).setHeaderText('禁用').setSortable(true).setFixedFilterInputConfig({valueItems: []}).setRenderFunction((cell, row_data) => {
                            cell.addNodes([
                                new Emt('p').setAttrsByStr('', (window.serverData.dataLib.dbdataColumnTable.isOk.map[row_data.is_ok] || '错误信息')),
                            ]);
                        });

                        datagrid.api.preCreateColumn('remark').setColumnInfo({}).setHeaderText('备注').setSortable(true).setFixedFilterInputConfig({valueItems: []});

                        datagrid.api.preCreateColumn('read_roles').setColumnInfo({}).setHeaderText('read_roles').setSortable(true).setFixedFilterInputConfig({valueItems: []});
                        datagrid.api.preCreateColumn('opt_roles').setColumnInfo({}).setHeaderText('opt_roles').setSortable(true).setFixedFilterInputConfig({valueItems: []});

                        datagrid.api.preCreateColumn('add_roles').setColumnInfo({}).setHeaderText('add_roles').setSortable(true).setFixedFilterInputConfig({valueItems: []});

                        datagrid.api.preCreateColumn('op').setColumnInfo({}).setHeaderText('操作').setSortable(true).setFixedFilterInputConfig({valueItems: []}).setRenderFunction((cell, row_data) => {
                            let btn_import_column = new Emt('button').setPros({textContent: '修改'});
                            btn_import_column.addEventListener('click', function () {

                                console.log('修改', cell, row_data);
                                valueRangeTable.clearItems();
                                // column_name_input_ele.value = row_data.column_name;

                                modal_edit.data_info = {cell: cell, row_data: row_data};
                                column_id_input.value = row_data.id;
                                column_name_input.value = row_data.column_name;
                                column_title_input.value = row_data.title;
                                column_sn_input.value = row_data.column_sn;
                                column_remark_input.value = row_data.remark;
                                column_inDataType_input.apiHandle.setInitVal(row_data.in_datatype);
                                column_outDataType_input.apiHandle.setInitVal(row_data.out_datatype);
                                let tmp_obj = {};
                                ['read_roles', 'opt_roles', 'add_roles'].forEach((column_name) => {
                                    if (row_data[column_name] === null) {
                                        tmp_obj[column_name] = [];
                                    } else {
                                        try {
                                            tmp_obj[column_name] = JSON.parse(row_data[column_name]);
                                        } catch (e) {
                                            tmp_obj[column_name] = [];
                                        }
                                    }
                                });
                                role_table.loadColumnsRoles(tmp_obj);

                                if (row_data.val_range === null) {
                                    row_data.val_range = '[]';
                                }
                                column_valRange_input.value = row_data.val_range;

                                let tmp_val_range = JSON.parse(row_data.val_range);
                                valueRangeTable.loadItems(tmp_val_range);

                                //handle_in_datatype_select.loadVal([row_data.out_datatype,'string','int','date']);


                                modal_edit.apiHandle.show();
                            });
                            cell.addNodes([btn_import_column]);
                        });


                        datagrid.api.run().api.requestData('init');


                    }
                }
            );
        </script>
        <style>
            .drag_sort_div {
                float: left;
                width: 100px;
            }

            .drag_sort_div > * {
                display: block;
                float: left;
            }
        </style>
    </div>
</div>


<footer class="footer">
    <div class="container">
        <p class="pull-left">&copy; My Company 2022</p>

        <p class="pull-right">Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></p>
    </div>
</footer>

<script src="/static/file/admin/js/jquery.js"></script>
<script src="/static/file/admin/js/bootstrap.js"></script>
</body>
</html>
