<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>story:</title>
    <link href="/static/file/admin/css/bootstrap.css" rel="stylesheet">
    <link href="/static/file/admin/css/site.css" rel="stylesheet">
    <link href="/static/file/admin/css/bg.css" rel="stylesheet">
</head>
<body>
<div class="wrap">
    <nav id="w0" class="navbar-inverse navbar-fixed-top navbar">
        <div class="container">
            <div class="navbar-header"></div>
            <div id="bg_menus_div" class="navbar-brand menus_root">story:</div>
            <div id="w0-collapse" class="collapse navbar-collapse">
                <ul id="w1" class="navbar-nav navbar-right nav">
                    <li><a href="/admin/dbdata/tables.html">story:</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <script src="/static/file/admin/js/hammer/kl-hammer.js"></script>
        <script src="/static/file/js/hammer-data.js"></script>
        <script src="/static/file/admin/js/string/string.js"></script>
        <script src="/static/file/admin/js/hammer-yii2/bootstrap.min.2022.10.07.0.js"></script>
        <script src="/static/file/admin/js/hammer-yii2/datagrid/datagrid.min.2022.10.07.0.js"></script>
        <script src="/static/file/admin/js/bg.js"></script>
        <script src="/static/file/admin/js/hammer/kl-hammer-editor.2022.11.01.1.js"></script>

        <div class="site-index">

            <div>

            </div>


            <div class="body-content" id="content_div">


            </div>

        </div>
        <script>
            let storys_condtion = {
                page: {index: 1, size: 1000},
                attr: {
                    story_id: 0,
                },
                table_name: 'd_story',
                sort: {story_desc_order: 'desc'}
            };
            let pageData = {
                commit_map: {},
                replyThis: function (step_div) {
                    alert('未被初始化');
                }
            };

            let markTree = function (data_rows, parent_story_id, lev) {
                console.log('树第N:', data_rows, parent_story_id);
                let story_infos = [];
                data_rows.forEach(function (story_info) {
                    if (story_info.story_id == parent_story_id) {
                        story_info.lev = lev;
                        story_info.nodes = markTree(data_rows, story_info.id, lev + 1);
                        story_infos.push(story_info);
                    }
                });
                return story_infos;
            };


            let markStoryStepDiv = function (commitInfo) {
                console.log('markStoryStepDiv', commitInfo);
                let step_div = new Emt('div', 'class="story_commit_div"',);
                let reply_div = new Emt('div', '', '', {});
                step_div.setAttribute('id', 'story_commit_div_' + commitInfo.id);

                let reply_this_btn = new Emt('button', 'type="button" class="reply_commit_btn"', '回复当前');
                if (commitInfo.detail.length > 0) {
                    step_div.addNodes([
                        new Emt('div', 'class="story_commit_detail_div"', '', {innerHTML: commitInfo.detail})
                    ]);
                }
                step_div.addNodes([
                    new Emt('div', 'class="short_info_div"').addNodes([
                        new Emt('span', 'class="id_span"', '#' + commitInfo.id),
                        new Emt('span', 'class="status_span"', '' + window.serverData.dataLib.commitType.map[commitInfo.step]),
                        new Emt('span', 'class="create_span"', commitInfo.__relat.create_by.info.real_name + '/' + commitInfo.create_time),
                        reply_div,
                    ]),
                ]);
                step_div.apiHandle = {
                    data: commitInfo,
                    ele: {replies_div: reply_div}
                };
                reply_this_btn.addEventListener('click', function () {
                    pageData.replyThis(step_div);
                });
                reply_div.addNode(reply_this_btn);

                if (parseInt(commitInfo.reply_id) > 0) {
                    reply_div.addNodes([new Emt('a', '', '父commit', {href: '#story_commit_div_' + commitInfo.reply_id})]);
                    if (pageData.commit_map[commitInfo.reply_id]) {
                        pageData.commit_map[commitInfo.reply_id].apiHandle.ele.replies_div.addNodes([
                            new Emt('a', '', '#' + commitInfo.id + '/' + commitInfo.__relat.create_by.info.real_name + '/' + commitInfo.create_time + '[' + window.serverData.dataLib.commitType.map[commitInfo.step] + ']', {href: '#story_commit_div_' + commitInfo.id})
                        ]);
                    }

                }
                pageData.commit_map[commitInfo.id] = step_div;
                return step_div;
            };
            domLoaded(function () {
                let utk = '';
                let role_infos = [];
                bg_init(function () {
                    utk = window.utk;
                    window.serverData.dataLib = {
                        admin: {items: [], list: [], map: {}},
                        commitType: {items: [], list: [], map: {}},
                        role: {items: [], list: [], map: {}},
                        storyType: {items: [], list: [], map: {}},
                        storyTableConfig: {}

                    };

                    kl.ajax({
                        url: '/dp/v1/admin/dbdata/select?user_token=' + utk,
                        data: {table_name: 'bg_rbac_role', page_index: 1, page_size: 1000},
                        type: 'json',
                        success: function (res_request_data) {
                            if (res_request_data.code && res_request_data.code === 'ok') {
                                res_request_data.data.dataRows.forEach((role_info) => {
                                    role_infos.push({val: role_info.role_code, text: role_info.role_name});
                                })
                            }
                        },
                        error: function (res_request_data) {
                        }
                    });

                    let getAdminList = function (fun) {
                        kl.ajax({
                            url: '/dp/v1/project/items?user_token=' + utk,
                            data: {item_code: 'admin'},
                            type: 'json',
                            success: function (res_request_data) {
                                if (typeof res_request_data.forEach === "function") {
                                    window.serverData.adminList = res_request_data;
                                    window.serverData.adminMap = {};
                                    res_request_data.forEach(function (adminInfo) {
                                        window.serverData.adminMap[adminInfo.val] = adminInfo.text;
                                    });
                                    fun();
                                } else {
                                    alert('获取表信息 请求结果异常');
                                    throw '别看了，连table info 信息都拿不到，还想干啥?';
                                }
                            },
                            error: function (res_request_data) {
                                console.log(res_request_data);
                                alert('获取表信息 网络异常');
                                throw '别看了，连table info 信息都拿不到，还想干啥?';

                            }
                        });
                    };

                    let getCommitTypeList = function (fun) {
                        kl.ajax({
                            url: '/dp/v1/project/items?user_token=' + utk,
                            data: {item_code: 'commit_type'},
                            type: 'json',
                            success: function (res_request_data) {
                                if (typeof res_request_data.forEach === "function") {
                                    window.serverData.dataLib.commitType.items = res_request_data;
                                    window.serverData.dataLib.commitType.items.forEach(function (commitTypeItem) {
                                        window.serverData.dataLib.commitType.map[commitTypeItem.val] = commitTypeItem.text;
                                    });
                                    fun();
                                } else {
                                    alert('获取表信息 请求结果异常');
                                    throw '别看了，连table info 信息都拿不到，还想干啥?';
                                }
                            },
                            error: function (res_request_data) {
                                console.log(res_request_data);
                                alert('获取表信息 网络异常');
                                throw '别看了，连table info 信息都拿不到，还想干啥?';

                            }
                        });
                    };

                    let getStoryTableInfo = function (fun) {
                        kl.ajax({
                            url: '/dp/v1/admin/dbdata/info?user_token=' + utk,
                            data: {table_name: 'd_story'},
                            type: 'json',
                            success: function (res_request_data) {
                                if (res_request_data.status) {
                                    if (res_request_data.status === 200) {

                                        res_request_data.data.columns.forEach(function (colInfo) {
                                            window.serverData.dataLib.storyTableConfig[colInfo.column_name] = colInfo;
                                        });

                                        //标准
                                        window.serverData.dataLib.storyType.items = window.serverData.dataLib.storyTableConfig.story_type.val_range;
                                        window.serverData.dataLib.storyType.items.forEach(function (storyTypItem) {
                                            window.serverData.dataLib.storyType.map[storyTypItem.val] = storyTypItem.text;
                                        });

                                        fun();
                                    } else {
                                        alert(' 获取表信息 错误:' + (res_request_data.message || '未知'));
                                        throw '别看了，连table info 信息都拿不到，还想干啥?';

                                    }
                                } else {
                                    alert('获取表信息 请求结果异常');
                                    throw '别看了，连table info 信息都拿不到，还想干啥?';
                                }
                            },
                            error: function (res_request_data) {
                                console.log(res_request_data);
                                alert('获取表信息 网络异常');
                                throw '别看了，连table info 信息都拿不到，还想干啥?';

                            }
                        });
                    };

                    let getStoryRowInfo = function () {
                        kl.ajax({
                            url: '/dp/v1/admin/dbdata/select?user_token=' + utk,
                            data: {table_name: 'd_story', attr: {id: window.serverData.story_id}},
                            type: 'json',
                            success: function (res_request_data) {
                                if (res_request_data.code && res_request_data.code === 'ok' && res_request_data.data && res_request_data.data.rowsTotal === 1) {
                                    window.serverData.storyInfo = res_request_data.data.dataRows[0];
                                    storys_condtion.attr.story_id = serverData.storyInfo.id;
                                    content();
                                }
                            },
                            error: function (res_request_data) {
                            }
                        });
                    };
                    getCommitTypeList(() => {
                        getAdminList(
                            function () {
                                getStoryTableInfo(
                                    function () {
                                        getStoryRowInfo()
                                    }
                                )
                            }
                        );
                    });


                });


                content = function () {
                    //kl.id('h1').textContent = kl.id('h1').textContent + window.serverData.storyInfo.id + '/' + window.serverData.storyInfo.title;
                    document.title = 'story:' + window.serverData.storyInfo.id + '/' + window.serverData.storyInfo.title;


                    let raw_root = kl.id('content_div');
                    let root = new Emt('div').setPros({className: 'row'});
                    raw_root.append(root);

                    let detail_root_div = new Emt('div', 'class="detail_root_div"');
                    let storys_root_div = new Emt('div', 'class="storys_root_div"');
                    let storys_list_div = new Emt('div', 'class="storys_list_div"');
                    let parent_story_div = new Emt('div', 'class="parent_story_div"');

                    let hammerYii2Bootstarp1 = hammerYii2Bootstarp();
                    let upload_file_modal = hammerYii2Bootstarp1.createModal({title: '上传文件'});


                    let story_title_h3 = new Emt('h3', '', '', {innerHTML: '[ ' + window.serverData.storyInfo.id + ' ] ' + window.serverData.storyInfo.title});
                    let story_detail_div = new Emt('div', '', '', {innerHTML: window.serverData.storyInfo.detail || '问题描述'});
                    let detail_ui_div = new Emt('div', '');
                    let story_detail_textarea = new Emt('textarea', 'class="hide"', '', {value: window.serverData.storyInfo.detail});


                    let form_edit = hammerYii2Bootstarp1.createForm({dataNameTpl: 'attr[$var]'});
                    form_edit.apiHandle.addGroupPreCreate().setLabelText('项目').setIndexKey('project_id').create('select');
                    form_edit.apiHandle.ele.input.project_id.apiHandle.setInitVal(window.serverData.storyInfo.project_id);
                    form_edit.apiHandle.ele.input.project_id.apiHandle.setRemoteItems('/dp/v1/project/items?user_token=' + utk, {item_code: 'project'});

                    form_edit.apiHandle.addGroupPreCreate().setLabelText('目标版本').setIndexKey('version_id').create('select');
                    form_edit.apiHandle.ele.input.version_id.apiHandle.setInitVal(window.serverData.storyInfo.version_id);
                    form_edit.apiHandle.ele.input.version_id.apiHandle.setRemoteItems('/dp/v1/project/items?user_token=' + utk, {item_code: 'version', project_id: window.serverData.storyInfo.project_id});
                    form_edit.apiHandle.ele.input.project_id.addEventListener('change', function () {
                        form_edit.apiHandle.ele.input.version_id.apiHandle.setRemoteItems('/dp/v1/project/items?user_token=' + utk, {item_code: 'version', project_id: form_edit.apiHandle.ele.input.project_id.apiHandle.getVal()});
                    });


                    form_edit.apiHandle.addGroupPreCreate().setLabelText('父级story').setIndexKey('parent_story_id').create('select');
                    form_edit.apiHandle.ele.input.parent_story_id.apiHandle.setInitVal(window.serverData.storyInfo.version_id);
                    form_edit.apiHandle.ele.input.parent_story_id.apiHandle.setRemoteItems('/dp/v1/project/items?user_token=' + utk, {item_code: 'story', version_id: window.serverData.storyInfo.version_id});
                    form_edit.apiHandle.ele.input.version_id.addEventListener('change', function () {
                        form_edit.apiHandle.ele.input.parent_story_id.apiHandle.setRemoteItems('/dp/v1/project/items?user_token=' + utk, {item_code: 'story', version_id: form_edit.apiHandle.ele.input.version_id.apiHandle.getVal()});
                    });


                    form_edit.apiHandle.addGroupPreCreate().setLabelText('story标题').setPlaceHolder('标题').setIndexKey('title').create('text');
                    form_edit.apiHandle.ele.input.title.apiHandle.setInitVal(window.serverData.storyInfo.title);

                    let detail_edit_div = new Emt('div');
                    let detail_edit_textarea = new Emt('textarea', 'rows="6" class="form-control hide" ', '', {value: window.serverData.storyInfo.detail || '尚未填写'});
                    let detail_group_div = hammerYii2Bootstarp1.createFormInputGroupDiv({text: '描述'});
                    detail_group_div.apiHandle.addInputEle(detail_edit_div);
                    detail_group_div.apiHandle.addInputEle(detail_edit_textarea);
                    form_edit.addNode(detail_group_div);


                    form_edit.apiHandle.addGroupPreCreate().setType('button').setContentText('保存').setIndexKey('submit').create('button');
                    form_edit.apiHandle.ele.input.submit.parentElement.className = 'col-sm-3';


                    let op_div = new Emt('div', 'class="hide"');
                    let display_div = new Emt('div');
                    let show_editor_btn = new Emt('button', 'type="button"', '编辑');
                    let exit_editor_btn = new Emt('button', 'type="button" ', '退出编辑');


                    let commits_div = new Emt('div');

                    let new_commit_form = hammerYii2Bootstarp1.createForm({dataNameTpl: 'commit[$var]'});
                    let reply_group_div = hammerYii2Bootstarp1.createFormInputGroupDiv({text: '回复:'});
                    let new_commit_reply_id = hammerYii2Bootstarp1.createHideInput({}).apiHandle.setInitVal(0);
                    let new_commit_reply_link = new Emt('a', '', '跳转至回复');
                    let new_commit_reply_checkbox = new Emt('input', 'type="checkbox"');

                    reply_group_div.apiHandle.addInputEle(new_commit_reply_id);
                    reply_group_div.apiHandle.addInputEle(new Emt('label').addNodes([
                        new Emt('span', '', '回复'),
                        new_commit_reply_checkbox,
                    ]));
                    reply_group_div.apiHandle.addInputEle(new_commit_reply_link);
                    new_commit_form.addNode(reply_group_div);


                    let new_commit_detail_ui_div = new Emt('div');
                    let new_commit_detail_textarea = new Emt('textarea', 'rows="6" class="form-control hide" ', '', {});
                    let new_commit_detail_group_div = hammerYii2Bootstarp1.createFormInputGroupDiv({text: '描述'});
                    new_commit_detail_group_div.apiHandle.addInputEle(new_commit_detail_ui_div);
                    new_commit_detail_group_div.apiHandle.addInputEle(new_commit_detail_textarea);
                    new_commit_form.addNode(new_commit_detail_group_div);


                    new_commit_form.apiHandle.addGroupPreCreate().setLabelText('耗时').setIndexKey('used_hours').create('number');
                    new_commit_form.apiHandle.ele.input.used_hours.apiHandle.setInitVal(0);
                    new_commit_form.apiHandle.ele.input.used_hours.parentElement.className = 'col-sm-3';


                    new_commit_form.apiHandle.addGroupPreCreate().setLabelText('跟踪人').setIndexKey('tracker').create('select');
                    new_commit_form.apiHandle.ele.input.tracker.apiHandle.setItems(window.serverData.adminList);
                    new_commit_form.apiHandle.ele.input.tracker.apiHandle.setInitVal(serverData.storyInfo.tracker);
                    new_commit_form.apiHandle.ele.input.tracker.parentElement.className = 'col-sm-3';

                    new_commit_form.apiHandle.addGroupPreCreate().setLabelText('类型').setIndexKey('story_type').create('select');
                    new_commit_form.apiHandle.ele.input.story_type.apiHandle.setItems(window.serverData.dataLib.storyType.items);
                    new_commit_form.apiHandle.ele.input.story_type.apiHandle.setInitVal(window.serverData.storyInfo.story_type);
                    new_commit_form.apiHandle.ele.input.story_type.parentElement.className = 'col-sm-3';

                    new_commit_form.apiHandle.addGroupPreCreate().setLabelText('状态').setIndexKey('step').create('select');
                    new_commit_form.apiHandle.ele.input.step.apiHandle.setItems(window.serverData.dataLib.commitType.items);
                    new_commit_form.apiHandle.ele.input.step.apiHandle.setInitVal('comment');


                    new_commit_form.apiHandle.ele.input.step.parentElement.className = 'col-sm-3';

                    new_commit_form.apiHandle.addGroupPreCreate().setLabelText('提交').setType('button').setContentText('提交commit').setIndexKey('commit').create('button');
                    new_commit_form.apiHandle.ele.input.commit.parentElement.className = 'col-sm-3';


                    root.addNodes([
                        detail_root_div.addNodes([
                            new Emt('h4', '', '描述'),
                            display_div.addNodes([
                                story_title_h3,
                                new Emt('p', 'class="break-line" style="border-bottom: 1px solid #AAA;padding-top: 20px;padding-bottom: 20px;"'),
                                story_detail_div,
                                new Emt('p').addNodes([
                                    show_editor_btn
                                ]),
                            ]),
                            op_div.addNodes([
                                form_edit,
                                new Emt('p').addNodes([
                                    exit_editor_btn
                                ]),
                            ]),
                            new Emt('div', 'class="short_info_div"').addNodes([
                                new Emt('span', 'class="create_span"', '创建:' + window.serverData.storyInfo.__relat.create_by.info.real_name + '/' + window.serverData.storyInfo.create_time),
                                new Emt('span', 'class="status_span"', '状态:' + window.serverData.dataLib.commitType.map[window.serverData.storyInfo.step]),
                            ])


                            //  new Emt('pre', '', JSON.stringify(window.serverData.storyInfo, null, 4))
                        ]),
                        storys_root_div.addNodes([
                            new Emt('h5', '', '父story:'),
                            parent_story_div,
                            new Emt('p'),
                            new Emt('h5', '', '子story列表:'),
                            new Emt('div').addNodes([

                                storys_list_div
                            ])

                        ]),
                        new Emt('h4', '', '变动历史:'),
                        commits_div
                    ]);

                    //初始化 story编辑 富文本
                    hammerEditor({
                        ui_ele: detail_edit_div,
                        data_ele: detail_edit_textarea,
                        btns: ('header,bold,fontsize,file').split(','),
                        funs: {
                            uploadFile: function (editorApiHandle) {
                                if (upload_file_modal.apiHandle.ele.body.childElementCount > 0) {
                                    console.log('之前的上传 还没用');
                                    upload_file_modal.apiHandle.show();
                                    return false;
                                }
                                let upload_groupDiv = hammerYii2Bootstarp1.createUploadGroupDiv({
                                    upload: {
                                        url: '/dp/v1/admin/file/upload?user_token=' + utk,
                                        params: {},

                                    }
                                });
                                upload_file_modal.apiHandle.addBodyChildElements([upload_groupDiv]);
                                upload_file_modal.apiHandle.show();
                                let filePlaceHolder = false;//只有这个玩意是来自于 editor.js  而upload_groupDiv是来自于UI.js
                                upload_groupDiv.apiHandle.addEventOnFileChanged(function () {
                                    let file_type = 'file';
                                    if (upload_groupDiv.apiHandle.file.type.match(/^image\//)) {
                                        file_type = 'image';
                                    } else if (upload_groupDiv.apiHandle.file.type.match(/^video\//)) {
                                        file_type = 'video';
                                    }
                                    filePlaceHolder = editorApiHandle.addFilePlaceHolder(upload_groupDiv.apiHandle.file.name, '#', file_type);//必须实现 确定了src 之后,回调 editor,让editor插入文件
                                    editorApiHandle.appendSyncElement(upload_groupDiv);
                                    upload_file_modal.apiHandle.hide();
                                    upload_groupDiv.apiHandle.uploadFile();

                                });

                                upload_groupDiv.apiHandle.addEventUploadOk(function (uploadRes) {
                                    if (uploadRes && uploadRes.code === 'ok' && uploadRes.data && uploadRes.data.url) {
                                        filePlaceHolder.setFilePlaceHolderSrc(uploadRes.data.url);
                                        editorApiHandle.flushDataToTextarea();
                                    }
                                });
                                upload_groupDiv.apiHandle.addEventUploadError(function (uploadRes) {
                                    filePlaceHolder.setFilePlaceHolderFilenameText('上传失败');
                                });


                            },
                            uploadPasteFile: function (editorApiHandle, filePlaceHolder) {
                                let upload_groupDiv = hammerYii2Bootstarp1.createUploadGroupDiv({
                                    upload: {
                                        url: '/dp/v1/admin/file/upload?user_token=' + utk,
                                        params: {},

                                    }
                                });
                                upload_file_modal.apiHandle.addBodyChildElements([upload_groupDiv]);
                                upload_file_modal.apiHandle.show();
                                upload_groupDiv.apiHandle.setSourceFile(filePlaceHolder.getSourceFile());
                                editorApiHandle.appendSyncElement(upload_groupDiv);
                                upload_file_modal.apiHandle.hide();
                                upload_groupDiv.apiHandle.uploadFile();


                                upload_groupDiv.apiHandle.addEventUploadOk(function (uploadRes) {
                                    if (uploadRes && uploadRes.code === 'ok' && uploadRes.data && uploadRes.data.url) {
                                        filePlaceHolder.setFilePlaceHolderSrc(uploadRes.data.url);
                                    }
                                });

                                upload_groupDiv.apiHandle.addEventUploadError(function (uploadRes) {
                                    filePlaceHolder.setFilePlaceHolderFilenameText('上传失败');
                                });


                            },
                            link: function (editor_insertLink_callback) {
                                let url = 'ddd';//必须实现  插入的视频 src
                                editor_insertLink_callback('link name', 'http://www.baidu.com');//必须实现 确定了src 之后,回调 editor,让editor插入链接
                            }
                        }
                    });
                    console.log(form_edit.apiHandle.ele.input.submit, form_edit.apiHandle.ele.input.submit.apiHandle);
                    //保存修改的数据
                    form_edit.apiHandle.ele.input.submit.apiHandle.setClickCall(function (btn) {
                        let attr = {
                            id: window.serverData.storyInfo.id,
                            project_id: form_edit.apiHandle.ele.input.project_id.apiHandle.getVal(),
                            version_id: form_edit.apiHandle.ele.input.version_id.apiHandle.getVal(),
                            story_id: form_edit.apiHandle.ele.input.parent_story_id.apiHandle.getVal(),
                            title: form_edit.apiHandle.ele.input.title.apiHandle.getVal(),
                            detail: detail_edit_textarea.value,
                        };
                        if (attr.title.length < 5) {
                            alert('标题过短');
                            return false;
                        }
                        console.log(btn, this, form_edit.apiHandle, attr);
                        // return false;
                        kl.ajax({
                            url: '/dp/v1/project/story/update?user_token=' + utk,
                            data: attr,
                            type: 'json',
                            success: function (save_story_res) {
                                if (save_story_res.status) {
                                    if (kl.isUndefined(save_story_res, 'data.story.id')) {
                                        alert('保存story错误:' + (save_story_res.msg || '未知'))
                                    } else {
                                        // window.location.reload();
                                        story_title_h3.innerHTML = save_story_res.data.story.title;
                                        story_detail_div.innerHTML = save_story_res.data.story.detail;
                                        display_div.classList.remove('hide');
                                        op_div.classList.add('hide');
                                    }
                                } else {
                                    console.log(save_story_res);
                                    alert('请求结果异常')
                                }
                            },
                            error: function (res_save_column) {
                                console.log(res_save_column);
                                alert('网络异常');
                            }
                        })
                    });
                    if ((['create_story']).indexOf(window.serverData.storyInfo.step) == -1) {
                        show_editor_btn.classList.add('hide');
                    }
                    show_editor_btn.addEventListener('click', function () {

                        display_div.classList.add('hide');
                        op_div.classList.remove('hide');

                    });
                    exit_editor_btn.addEventListener('click', function () {
                        display_div.classList.remove('hide');
                        op_div.classList.add('hide');

                        story_detail_textarea.value = window.serverData.storyInfo.detail;
                        detail_ui_div.innerHTML = '';

                    });


                    //初始化  new commit 富文本
                    hammerEditor({
                        ui_ele: new_commit_detail_ui_div,
                        data_ele: new_commit_detail_textarea,
                        btns: ('header,bold,fontsize,file').split(','),
                        funs: {
                            uploadFile: function (editorApiHandle) {
                                if (upload_file_modal.apiHandle.ele.body.childElementCount > 0) {
                                    console.log('之前的上传 还没用');
                                    upload_file_modal.apiHandle.show();
                                    return false;
                                }
                                let upload_groupDiv = hammerYii2Bootstarp1.createUploadGroupDiv({
                                    upload: {
                                        url: '/dp/v1/admin/file/upload?user_token=' + utk,
                                        params: {},

                                    }
                                });
                                upload_file_modal.apiHandle.addBodyChildElements([upload_groupDiv]);
                                upload_file_modal.apiHandle.show();
                                let filePlaceHolder = false;//只有这个玩意是来自于 editor.js  而upload_groupDiv是来自于UI.js
                                upload_groupDiv.apiHandle.addEventOnFileChanged(function () {
                                    let file_type = 'file';
                                    if (upload_groupDiv.apiHandle.file.type.match(/^image\//)) {
                                        file_type = 'image';
                                    } else if (upload_groupDiv.apiHandle.file.type.match(/^video\//)) {
                                        file_type = 'video';
                                    }
                                    filePlaceHolder = editorApiHandle.addFilePlaceHolder(upload_groupDiv.apiHandle.file.name, '#', file_type);//必须实现 确定了src 之后,回调 editor,让editor插入文件
                                    editorApiHandle.appendSyncElement(upload_groupDiv);
                                    upload_file_modal.apiHandle.hide();
                                    upload_groupDiv.apiHandle.uploadFile();

                                });

                                upload_groupDiv.apiHandle.addEventUploadOk(function (uploadRes) {
                                    if (uploadRes && uploadRes.code === 'ok' && uploadRes.data && uploadRes.data.url) {
                                        filePlaceHolder.setFilePlaceHolderSrc(uploadRes.data.url);
                                        editorApiHandle.flushDataToTextarea();
                                    }
                                });
                                upload_groupDiv.apiHandle.addEventUploadError(function (uploadRes) {
                                    filePlaceHolder.setFilePlaceHolderFilenameText('上传失败');
                                });


                            },
                            uploadPasteFile: function (editorApiHandle, filePlaceHolder) {
                                let upload_groupDiv = hammerYii2Bootstarp1.createUploadGroupDiv({
                                    upload: {
                                        url: '/dp/v1/admin/file/upload?user_token=' + utk,
                                        params: {},

                                    }
                                });
                                upload_file_modal.apiHandle.addBodyChildElements([upload_groupDiv]);
                                upload_file_modal.apiHandle.show();
                                upload_groupDiv.apiHandle.setSourceFile(filePlaceHolder.getSourceFile());
                                editorApiHandle.appendSyncElement(upload_groupDiv);
                                upload_file_modal.apiHandle.hide();
                                upload_groupDiv.apiHandle.uploadFile();


                                upload_groupDiv.apiHandle.addEventUploadOk(function (uploadRes) {
                                    if (uploadRes && uploadRes.code === 'ok' && uploadRes.data && uploadRes.data.url) {
                                        filePlaceHolder.setFilePlaceHolderSrc(uploadRes.data.url);
                                    }
                                });

                                upload_groupDiv.apiHandle.addEventUploadError(function (uploadRes) {
                                    filePlaceHolder.setFilePlaceHolderFilenameText('上传失败');
                                });


                            },
                            link: function (editor_insertLink_callback) {
                                let url = 'ddd';//必须实现  插入的视频 src
                                editor_insertLink_callback('link name', 'http://www.baidu.com');//必须实现 确定了src 之后,回调 editor,让editor插入链接
                            }
                        }
                    });

                    new_commit_reply_checkbox.changeVal = function () {
                        new_commit_reply_checkbox.checked ? new_commit_reply_link.classList.remove('hide') : new_commit_reply_link.classList.add('hide');
                    };
                    new_commit_reply_checkbox.addEventListener('change', function () {
                        new_commit_reply_checkbox.changeVal();
                    });


                    new_commit_form.apiHandle.ele.input.commit.apiHandle.setClickCall(function (btn) {
                        let attr = {
                            story_id: window.serverData.storyInfo.id,
                            reply_id: new_commit_reply_checkbox.checked ? new_commit_reply_id.value : 0,
                            used_hours: new_commit_form.apiHandle.ele.input.used_hours.apiHandle.getVal(),
                            step: new_commit_form.apiHandle.ele.input.step.apiHandle.getVal(),
                            detail: new_commit_detail_textarea.value,
                            create_by: window.adminInfo.user_id,
                            tracker: new_commit_form.apiHandle.ele.input.tracker.apiHandle.getVal(),
                            story_type: new_commit_form.apiHandle.ele.input.story_type.apiHandle.getVal(),
                        };


                        if (new_commit_form.apiHandle.ele.input.tracker.apiHandle.isChange()) {
                            let old_tracker = (window.serverData.adminMap[window.serverData.storyInfo.tracker] || '') + '(' + window.serverData.storyInfo.tracker + ')';
                            let new_tracker = (window.serverData.adminMap[attr.tracker] || '') + '(' + attr.tracker.toString() + ')';

                            attr.detail = attr.detail + "\n 更换跟踪人  原跟踪人:" + old_tracker + " 新跟踪人: " + new_tracker + "\n";
                        }

                        if (new_commit_form.apiHandle.ele.input.story_type.apiHandle.isChange()) {
                            let old_type = (window.serverData.dataLib.storyType.map[window.serverData.storyInfo.story_type] || '') + '(' + window.serverData.storyInfo.story_type + ')';
                            let new_type = (window.serverData.dataLib.storyType.map[attr.story_type] || '') + '(' + attr.story_type.toString() + ')';

                            attr.detail = attr.detail + "\n 更换story类型  原类型:" + old_type + " 新类型: " + new_type + "\n";
                        }


                        console.log(btn, this, new_commit_form.apiHandle, attr);
                        kl.ajax({
                            url: '/dp/v1/project/story/commit/add?user_token=' + utk,
                            data: attr,
                            type: 'json',
                            success: function (save_story_res) {
                                if (save_story_res.status) {
                                    if (kl.isUndefined(save_story_res, 'data.commit.id')) {
                                        alert('保存commit错误:' + (save_story_res.msg || '未知'))
                                    } else {
                                        document.location.reload();
                                    }
                                } else {
                                    console.log(save_story_res);
                                    alert('请求结果异常')
                                }
                            },
                            error: function (res_save_column) {
                                console.log(res_save_column);
                                alert('网络异常');
                            }
                        })
                    });


                    window.dragedEle = false;

                    let display_parent_story = function () {
                        kl.ajax({
                            url: '/dp/v1/admin/dbdata/select?user_token=' + utk,
                            data: {
                                attr: {
                                    id: window.serverData.storyInfo.story_id,
                                },
                                table_name: 'd_story',
                            },
                            type: 'json',
                            success: function (res_request_data) {
                                if (res_request_data.status) {
                                    if (res_request_data.status === 200 && res_request_data.data.dataRows.length === 1) {
                                        parent_story_div.addNode(new Emt('a', '', res_request_data.data.dataRows[0].title, {href: '/admin/project/story/detail.html?{"story_id":' + res_request_data.data.dataRows[0].id + '}'}));
                                    } else {
                                        alert('获取父story 错误:' + (res_request_data.msg || '未知'))
                                    }
                                } else {
                                    console.log(res_request_data.status);
                                    alert('获取父story 请求结果异常')
                                }
                            },
                            error: function (res_request_data) {
                                console.log(res_request_data);
                                alert('获取父story 网络异常');
                            }
                        });
                    };
                    if (window.serverData.storyInfo.story_id === '0') {
                        parent_story_div.textContent = '无父级';
                    } else {
                        display_parent_story();
                    }

                    let display_story_commits = function () {
                        kl.ajax({
                            url: '/dp/v1/admin/dbdata/select?user_token=' + utk,
                            data: {
                                attr: {
                                    story_id: window.serverData.storyInfo.id,
                                },
                                table_name: 'd_story_commit',
                                page_index: 1, page_size: 1000
                            },
                            type: 'json',
                            success: function (res_request_data) {
                                if (res_request_data.status) {
                                    if (res_request_data.status === 200 && res_request_data.data.dataRows) {
                                        res_request_data.data.dataRows.forEach((commitInfo) => {
                                            commits_div.addNode(markStoryStepDiv(commitInfo));
                                        });
                                        pageData.replyThis = function (oldStepDiv) {
                                            new_commit_reply_link.href = "#" + oldStepDiv.id;
                                            new_commit_reply_link.textContent = "#" + oldStepDiv.apiHandle.data.id + oldStepDiv.textContent.substr(0, 20);

                                            new_commit_reply_id.value = oldStepDiv.apiHandle.data.id;
                                            new_commit_reply_checkbox.checked = true;
                                            new_commit_reply_checkbox.changeVal();
                                        };
                                        commits_div.addNode(new Emt('div', 'class="story_commit_div"').addNode(new_commit_form));
                                    } else {
                                        alert('获取story commits 错误:' + (res_request_data.msg || '未知'))
                                    }
                                } else {
                                    console.log(res_request_data.status);
                                    alert('获取story commits 请求结果异常')
                                }
                            },
                            error: function (res_request_data) {
                                console.log(res_request_data);
                                alert('获取story commits 网络异常');
                            }
                        });
                    };

                    display_story_commits();

                    let flush_story_list = function () {
                        kl.ajax({
                            url: '/dp/v1/admin/dbdata/select?user_token=' + utk,
                            data: storys_condtion,
                            type: 'json',
                            success: function (res_request_data) {
                                if (res_request_data.status) {
                                    if (res_request_data.status === 200) {
                                        rander_storys_list(res_request_data.data.dataRows);
                                    } else {
                                        alert('错误:' + (res_request_data.msg || '未知'))
                                    }
                                } else {
                                    console.log(res_request_data.status);
                                    alert('请求结果异常')
                                }
                            },
                            error: function (res_request_data) {
                                console.log(res_request_data);
                                alert('网络异常');
                            }
                        });
                    };
                    flush_story_list();


                    let rander_storys_list = function (dataRows) {
                        storys_list_div.innerHTML = '';


                        let tmp_arr = markTree(dataRows, window.serverData.storyInfo.id, 1);
                        console.log('markTree', tmp_arr);
                        let story_table = new Emt('table', 'class="table table-bordered table-striped table-hover"');
                        story_table.createRow = function () {
                            let res = {};
                            let tr = story_table.insertRow();
                            tr.className = "story_row";
                            res.tr = tr;
                            res.id_td = tr.insertCell();
                            res.title_td = tr.insertCell();
                            res.creator_td = tr.insertCell();
                            res.status_td = tr.insertCell();
                            res.desc_order_td = tr.insertCell();
                            res.create_date_td = tr.insertCell();
                            res.update_date_td = tr.insertCell();
                            res.op_td = tr.insertCell();

                            res.tr.className = "story_row";
                            res.id_td.className = "story_id_td";
                            res.title_td.className = "story_title_td";
                            res.creator_td.className = "story_creator_td";
                            res.status_td.className = "story_status_td";
                            res.desc_order_td.className = "story_desc_order_td";
                            res.create_date_td.className = "story_create_date_td";
                            res.update_date_td.className = "story_update_date_td";
                            res.op_td.className = "story_op_td";


                            tr.setStoryInfo = function (story_info) {
                                tr.apiHandle = {data: story_info};
                                res.id_td.append(new Emt('div', '', story_info.id));
                                res.title_td.append(new Emt('div', '', story_info.title));
                                res.creator_td.append(new Emt('div', '', story_info.__relat.create_by.info.real_name));
                                res.status_td.append(new Emt('div', '', window.serverData.dataLib.commitType.map[story_info.step]));
                                res.desc_order_td.append(new Emt('div', '', story_info.story_desc_order));
                                res.create_date_td.append(new Emt('div', '', story_info.create_time));
                                res.update_date_td.append(new Emt('div', '', story_info.update_time ? story_info.update_time : '#'));
                                res.op_td.append(new Emt('div').addNodes([
                                    new Emt('a', '', '查看', {target: '_blank', href: '/admin/project/story/detail.html?{"story_id":' + story_info.id + '}'}),
                                    new Emt('a', '', '添加子问题', {target: '_blank', href: '/admin/project/story/add.html?{"parent_story_id":' + story_info.id + '}'})
                                ]));
                                tr.classList.add('story_status_' + story_info.step);
                            };

                            return res;
                        };
                        let story_header = story_table.createRow();
                        story_header.tr.setStoryInfo({
                            id: 'ID',
                            title: '标题',
                            __relat: {create_by: {info: {real_name: '创建人'}}},
                            story_desc_order: '优先级',
                            create_time: '创建时间',
                            update_time: '修改时间',
                            step: 'header',
                        });
                        story_header.status_td.textContent = '状态';
                        story_header.op_td.innerHTML = '';
                        story_header.op_td.append(new Emt('div').addNodes([
                            new Emt('a', '', '添加子问题', {target: '_blank', href: '/admin/project/story/add.html?{"parent_story_id":' + window.serverData.storyInfo.id + '}'})
                        ]));


                        story_table.appendStoryRowAsTree = function (story_info) {
                            let res = story_table.createRow();
                            res.tr.setStoryInfo(story_info);
                            if (story_info.nodes.length > 0) {
                                story_info.nodes.forEach(function (story_info2) {
                                    story_table.appendStoryRowAsTree(story_info2);
                                });
                            }
                        };


                        dataRows.forEach(function (story_info) {
                            let res = story_table.createRow();
                            res.tr.setStoryInfo(story_info);
                        });

                        storys_list_div.addNode(story_table);

                    };


                    window.dragedEle = false;

                };
                setInterval(function () {
                    let imgs = Object.values(document.getElementsByTagName('img'));
                    imgs.forEach(function (img) {
                        if (img.init === undefined) {
                            img.classList.add('img_small_size');
                            img.addEventListener('click', function () {
                                img.classList.toggle('img_small_size');
                            });
                            img.init = true;
                        }
                    })
                }, 1000);
            });
        </script>
        <style>
            .hide {
                display: none;
            }

            .drag_sort_div {
                float: left;
                width: 100px;
            }

            .drag_sort_div > * {
                display: block;
                float: left;
            }

            .story_row {
                margin: 10px;
            }

            .story_row > td > div {
                display: block;
                padding: 10px;
            }

            .on_drag_row > td > div {
                background: #000;
                color: #FFF;
            }

            .on_drop_row > td > div {
                background: #ffff00;
                color: #00F;
            }

            .story_commit_div {
                border-left: 1px solid #000;
                margin-top: 10px;
                -margin-bottom: 40px;
                padding: 10px;
                background: #f9f9f9;
            }

            .story_commit_detail_div {
                padding: 10px;
                border-bottom: 1px solid #000;
            }

            h4 {
                background: #337ab7;
                background: #777;
                padding-top: 10px;
                padding-bottom: 10px;

                color: #FFF;
                font-weight: 900;
                margin-top: 50px;
                padding-left: 20px;
            }

            h4 + div {
                margin-left: 20px;
                border: 1px solid #666;
                padding: 20px;
                border-radius: 4px;
            }

            h5 {
                padding-top: 10px;
                padding-bottom: 10px;
                color: #AAA;
                font-weight: 900;
                padding-left: 20px;
            }


            h5 + div {
                margin-left: 20px;

            }

            .storys_list_div {
                -padding: 20px;
            }

            .short_info_div {
                padding-left: 20px;
                padding-top: 10px;
                min-height: 3em;
            }

            .short_info_div > span {
                display: block;
                float: left;
                background: #CCC;
                border-radius: 4px;
                margin-right: 5px;
                padding: 5px;
            }

            .reply_commit_btn {
                display: block;
                float: left;
                background: #CCC;
                border-radius: 4px;
                margin-right: 5px;
                padding: 2.5px;
            }

            .img_small_size {
                max-height: 300px;
                max-width: 800px;
                width: auto;
                height: auto;
            }

            .story_op_td > div > a {
                display: block;
                float: left;
                margin-right: 5px;
                padding: 5px;
            }
        </style>
    </div>
</div>


<footer class="footer">
    <div class="container">
        <p class="pull-left">&copy; My Company 2022</p>

        <p class="pull-right">Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></p>
    </div>
</footer>

<script src="/static/file/admin/js/jquery.js"></script>
<script src="/static/file/admin/js/bootstrap.js"></script>
</body>
</html>
