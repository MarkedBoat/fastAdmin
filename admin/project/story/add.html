<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>story:</title>
    <link href="/static/file/admin/css/bootstrap.css" rel="stylesheet">
    <link href="/static/file/admin/css/site.css" rel="stylesheet">
    <link href="/static/file/admin/css/bg.css" rel="stylesheet">
</head>
<body>
<div class="wrap">
    <nav id="w0" class="navbar-inverse navbar-fixed-top navbar">
        <div class="container">
            <div class="navbar-header"></div>
            <div id="bg_menus_div" class="navbar-brand menus_root">story:</div>
            <div id="w0-collapse" class="collapse navbar-collapse">
                <ul id="w1" class="navbar-nav navbar-right nav">
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <script src="/static/file/admin/js/hammer/kl-hammer.js"></script>
        <script src="/static/file/admin/js/string/string.js"></script>
        <script src="/static/file/admin/js/hammer-yii2/bootstrap.min.2022.10.07.0.js"></script>
        <script src="/static/file/admin/js/hammer-yii2/datagrid/datagrid.min.2022.10.07.0.js"></script>
        <script src="/static/file/admin/js/hammer/kl-hammer-editor.2022.11.01.1.js"></script>

        <script src="/static/file/admin/js/bg.js"></script>

        <div class="site-index">

            <div>

            </div>


            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="page-header" id="h1">添加STORY</h3>
                </div>
                <div class="panel-body">
                    <p id="subject_detail"></p>
                </div>
            </div>


            <div class="body-content" id="content_div">


            </div>

        </div>
        <script>

            let markTree = function (data_rows, parent_story_id, lev) {
                console.log('树第N:', data_rows, parent_story_id);
                let story_infos = [];
                data_rows.forEach(function (story_info) {
                    if (story_info.story_id == parent_story_id) {
                        story_info.lev = lev;
                        story_info.nodes = markTree(data_rows, story_info.id, lev + 1);
                        story_infos.push(story_info);
                    }
                });
                return story_infos;
            };

            //{
            // project_id_selectInput:
            // version_id_selectInput:
            // callbackFun
            // }
            let flushStoryItems = function (opt) {
                let search_data = {
                    page_index: 1, page_size: 1000,
                    attr: {},
                    sort: {story_desc_order: 'desc'},
                    project_id: '#',
                    version_id: '#',
                };

                search_data.project_id = opt.project_id_selectInput.apiHandle.getVal();

                search_data.version_id = opt.version_id_selectInput.apiHandle.getVal();


                kl.ajax({
                    url: '/dp/v1/project/story/list?user_token=' + utk,
                    data: search_data,
                    type: 'json',
                    success: function (res_request_data) {
                        if (res_request_data.status) {
                            if (res_request_data.status === 200) {
                                opt.callbackFun(res_request_data.data.dataRows);
                            } else {
                                alert('错误:' + (res_request_data.msg || '未知'))
                            }
                        } else {
                            console.log(res_request_data.status);
                            alert('请求结果异常')
                        }
                    },
                    error: function (res_request_data) {
                        console.log(res_request_data);
                        alert('网络异常');
                    }
                });
            };

            domLoaded(function () {
                    let utk = '';
                    let role_infos = [];
                    bg_init(function () {
                        utk = window.utk;

                        let getRoleList = function (fun) {
                            kl.ajax({
                                url: '/dp/v1/admin/dbdata/select?user_token=' + utk,
                                data: {table_name: 'bg_rbac_role', page_index: 1, page_size: 1000},
                                type: 'json',
                                success: function (res_request_data) {
                                    if (res_request_data.code && res_request_data.code === 'ok') {
                                        res_request_data.data.dataRows.forEach((role_info) => {
                                            role_infos.push({val: role_info.role_code, text: role_info.role_name});
                                        });
                                        fun();
                                    }
                                },
                                error: function (res_request_data) {
                                }
                            });
                        };


                        let getAdminList = function (fun) {
                            kl.ajax({
                                url: '/dp/v1/project/items?user_token=' + utk,
                                data: {item_code: 'admin'},
                                type: 'json',
                                success: function (res_request_data) {
                                    if (typeof res_request_data.forEach === "function") {
                                        window.serverData.admin = {items: res_request_data, map: {}};
                                        res_request_data.forEach(function (adminInfo) {
                                            window.serverData.admin.map[adminInfo.val] = adminInfo.text;
                                        });
                                        fun();
                                    } else {
                                        alert('获取表信息 请求结果异常');
                                        throw '别看了，连table info 信息都拿不到，还想干啥?';
                                    }
                                },
                                error: function (res_request_data) {
                                    console.log(res_request_data);
                                    alert('获取表信息 网络异常');
                                    throw '别看了，连table info 信息都拿不到，还想干啥?';

                                }
                            });
                        };

                        let getStoryTableConfigInfo = function (fun) {
                            kl.ajax({
                                url: '/dp/v1/admin/dbdata/info?user_token=' + utk,
                                data: {table_name: 'd_story'},
                                type: 'json',
                                success: function (res_request_data) {
                                    if (res_request_data.status) {
                                        if (res_request_data.status === 200) {

                                            window.serverData.storyTable = {
                                                allColumn: {map: {}, items: res_request_data.data.columns},
                                                status: {map: {}, items: []},
                                                storyType: {map: {}, items: []},
                                            };

                                            res_request_data.data.columns.forEach(function (colInfo) {
                                                window.serverData.storyTable.allColumn.map[colInfo.column_name] = colInfo;
                                            });
                                            window.serverData.storyTable.status.items = window.serverData.storyTable.allColumn.map.step.val_range;
                                            window.serverData.storyTable.status.items.forEach(function (itemInfo) {
                                                window.serverData.storyTable.status.map[itemInfo.val] = itemInfo.text;
                                            });
                                            window.serverData.storyTable.storyType.items = window.serverData.storyTable.allColumn.map.story_type.val_range;
                                            window.serverData.storyTable.storyType.items.forEach(function (itemInfo) {
                                                window.serverData.storyTable.storyType.map[itemInfo.val] = itemInfo.text;
                                            });
                                            fun();
                                        } else {
                                            alert(' 获取表信息 错误:' + (res_request_data.message || '未知'));
                                            throw '别看了，连table info 信息都拿不到，还想干啥?';

                                        }
                                    } else {
                                        alert('获取表信息 请求结果异常');
                                        throw '别看了，连table info 信息都拿不到，还想干啥?';
                                    }
                                },
                                error: function (res_request_data) {
                                    console.log(res_request_data);
                                    alert('获取表信息 网络异常');
                                    throw '别看了，连table info 信息都拿不到，还想干啥?';

                                }
                            });
                        };

                        let getUnTimeOverVersionInfos = function (fun) {
                            kl.ajax({
                                url: '/dp/v1/project/version/list?user_token=' + utk,
                                data: {isSkipTimeOver: 'yes'},
                                type: 'json',
                                success: function (version_info_res) {
                                    if (!kl.isUndefined(version_info_res, 'data.list') && typeof version_info_res.data.list.forEach === 'function') {
                                        window.serverData.version = {list: version_info_res.data.list, items: [], map: {}};
                                        window.serverData.version.list.forEach((versionInfo) => {
                                            window.serverData.version.items.push({text: versionInfo.title, val: versionInfo.id});
                                            window.serverData.version.map[versionInfo.id] = versionInfo;
                                        });
                                        fun();
                                    } else {
                                        alert('请求versions 数据异常');
                                    }
                                },
                                error: function (version_info_res) {
                                    console.log(version_info_res);
                                    alert('请求版本信息 网络错误');
                                }
                            });
                        };


                        getAdminList(() => {
                            getStoryTableConfigInfo(() => {
                                getUnTimeOverVersionInfos(function () {
                                    content();
                                });
                            });
                        });

                    });


                    content = function () {
                        //  kl.id('h1').textContent = kl.id('h1').textContent + ':' + window.serverData.parentStoryInfo.id + '/' + window.serverData.parentStoryInfo.title;
                        //  document.title = '目标版本:' + serverData.table.title + '/' + serverData.table.table_name;


                        let raw_root = kl.id('content_div');
                        let root = new Emt('div').setPros({className: 'row'});
                        raw_root.append(root);

                        let project_detail_div = new Emt('div');
                        let version_detail_div = new Emt('div');
                        let storys_root_div = new Emt('div');
                        let parent_story_div = new Emt('div');

                        let hammerYii2Bootstarp1 = hammerYii2Bootstarp();
                        let upload_file_modal = hammerYii2Bootstarp1.createModal({title: '上传文件'});

                        root.addNodes([

                            storys_root_div.addNodes([
                                new Emt('h1', '', '父story:'),
                                new Emt('pre', '',),
                                parent_story_div,
                                new Emt('p'),
                            ])
                        ]);


                        let form_edit = hammerYii2Bootstarp1.createForm({dataNameTpl: 'attr[$var]'});
                        root.addNode(form_edit);


                        form_edit.apiHandle.addGroupPreCreate().setLabelText('项目').setIndexKey('project_id').create('select');
                        form_edit.apiHandle.ele.input.project_id.apiHandle.setInitVal('#');
                        form_edit.apiHandle.ele.input.project_id.apiHandle.setRemoteItems('/dp/v1/project/items?user_token=' + utk, {item_code: 'project'});

                        form_edit.apiHandle.addGroupPreCreate().setLabelText('目标版本').setIndexKey('version_id').create('select');
                        form_edit.apiHandle.ele.input.version_id.apiHandle.setItems(window.serverData.version.items);
                        form_edit.apiHandle.ele.input.version_id.apiHandle.setInitVal(0);

                        form_edit.apiHandle.addGroupPreCreate().setLabelText('父级story').setIndexKey('parent_story_id').create('select');
                        form_edit.apiHandle.ele.input.parent_story_id.apiHandle.setInitVal('0');


                        form_edit.apiHandle.addGroupPreCreate().setLabelText('类型').setIndexKey('storyType').create('select');
                        form_edit.apiHandle.ele.input.storyType.apiHandle.setItems(window.serverData.storyTable.storyType.items);
                        form_edit.apiHandle.ele.input.storyType.apiHandle.setInitVal('story');

                        form_edit.apiHandle.addGroupPreCreate().setLabelText('跟踪人').setIndexKey('tracker').create('select');
                        form_edit.apiHandle.ele.input.tracker.apiHandle.setItems(window.serverData.admin.items);
                        form_edit.apiHandle.ele.input.tracker.apiHandle.setInitVal('#');


                        form_edit.apiHandle.addGroupPreCreate().setLabelText('story标题').setPlaceHolder('标题').setIndexKey('title').setNameVar('title').create('text');
                        let story_title_input = form_edit.apiHandle.ele.input.title;

                        let detail_edit_div = new Emt('div');
                        let detail_edit_textarea = new Emt('textarea', 'rows="6" class="form-control hide" ');
                        let detail_group_div = hammerYii2Bootstarp1.createFormInputGroupDiv({text: '描述'});
                        detail_group_div.apiHandle.addInputEle(detail_edit_div);
                        detail_group_div.apiHandle.addInputEle(detail_edit_textarea);
                        form_edit.addNode(detail_group_div);


                        hammerEditor({
                            ui_ele: detail_edit_div,
                            data_ele: detail_edit_textarea,
                            btns: ('header,bold,fontsize,file').split(','),
                            funs: {
                                uploadFile: function (editorApiHandle) {
                                    if (upload_file_modal.apiHandle.ele.body.childElementCount > 0) {
                                        console.log('之前的上传 还没用');
                                        upload_file_modal.apiHandle.show();
                                        return false;
                                    }
                                    let upload_groupDiv = hammerYii2Bootstarp1.createUploadGroupDiv({
                                        upload: {
                                            url: '/dp/v1/admin/file/upload?user_token=' + utk,
                                            params: {},

                                        }
                                    });
                                    upload_file_modal.apiHandle.addBodyChildElements([upload_groupDiv]);
                                    upload_file_modal.apiHandle.show();
                                    let filePlaceHolder = false;//只有这个玩意是来自于 editor.js  而upload_groupDiv是来自于UI.js
                                    upload_groupDiv.apiHandle.addEventOnFileChanged(function () {
                                        let file_type = 'file';
                                        if (upload_groupDiv.apiHandle.file.type.match(/^image\//)) {
                                            file_type = 'image';
                                        } else if (upload_groupDiv.apiHandle.file.type.match(/^video\//)) {
                                            file_type = 'video';
                                        }
                                        filePlaceHolder = editorApiHandle.addFilePlaceHolder(upload_groupDiv.apiHandle.file.name, '#', file_type);//必须实现 确定了src 之后,回调 editor,让editor插入文件
                                        editorApiHandle.appendSyncElement(upload_groupDiv);
                                        upload_file_modal.apiHandle.hide();
                                        upload_groupDiv.apiHandle.uploadFile();

                                    });

                                    upload_groupDiv.apiHandle.addEventUploadOk(function (uploadRes) {
                                        if (uploadRes && uploadRes.code === 'ok' && uploadRes.data && uploadRes.data.url) {
                                            filePlaceHolder.setFilePlaceHolderSrc(uploadRes.data.url);
                                            editorApiHandle.flushDataToTextarea();
                                        }
                                    });
                                    upload_groupDiv.apiHandle.addEventUploadError(function (uploadRes) {
                                        filePlaceHolder.setFilePlaceHolderFilenameText('上传失败');
                                    });


                                },
                                uploadPasteFile: function (editorApiHandle, filePlaceHolder) {
                                    let upload_groupDiv = hammerYii2Bootstarp1.createUploadGroupDiv({
                                        upload: {
                                            url: '/dp/v1/admin/file/upload?user_token=' + utk,
                                            params: {},

                                        }
                                    });
                                    upload_file_modal.apiHandle.addBodyChildElements([upload_groupDiv]);
                                    upload_file_modal.apiHandle.show();
                                    upload_groupDiv.apiHandle.setSourceFile(filePlaceHolder.getSourceFile());
                                    editorApiHandle.appendSyncElement(upload_groupDiv);
                                    upload_file_modal.apiHandle.hide();
                                    upload_groupDiv.apiHandle.uploadFile();


                                    upload_groupDiv.apiHandle.addEventUploadOk(function (uploadRes) {
                                        if (uploadRes && uploadRes.code === 'ok' && uploadRes.data && uploadRes.data.url) {
                                            filePlaceHolder.setFilePlaceHolderSrc(uploadRes.data.url);
                                        }
                                    });

                                    upload_groupDiv.apiHandle.addEventUploadError(function (uploadRes) {
                                        filePlaceHolder.setFilePlaceHolderFilenameText('上传失败');
                                    });


                                },
                                link: function (editor_insertLink_callback) {
                                    let url = 'ddd';//必须实现  插入的视频 src
                                    editor_insertLink_callback('link name', 'http://www.baidu.com');//必须实现 确定了src 之后,回调 editor,让editor插入链接
                                }
                            }
                        });


                        form_edit.apiHandle.addGroupPreCreate().setType('button').setContentText('保存').setIndexKey('submit').setClickCall(function (btn) {
                            let attr = {
                                project_id: form_edit.apiHandle.ele.input.project_id.apiHandle.getVal(),
                                version_id: form_edit.apiHandle.ele.input.version_id.apiHandle.getVal(),
                                story_id: form_edit.apiHandle.ele.input.parent_story_id.apiHandle.getVal(),
                                story_type: form_edit.apiHandle.ele.input.storyType.apiHandle.getVal(),
                                tracker: form_edit.apiHandle.ele.input.tracker.apiHandle.getVal(),
                                title: form_edit.apiHandle.ele.input.title.apiHandle.getVal(),
                                detail: detail_edit_textarea.value,
                            };
                            if (attr.title.length < 5) {
                                alert('标题过短');
                                return false;
                            }
                            console.log(btn, this, form_edit.apiHandle, attr);
                            kl.ajax({
                                url: '/dp/v1/project/story/add?user_token=' + utk,
                                //attr: form,
                                data:attr,
                                type: 'json',
                                success: function (save_story_res) {
                                    if (save_story_res.status) {
                                        if (kl.isUndefined(save_story_res, 'data.story.id')) {
                                            alert('错误:' + (save_story_res.msg || '未知'))
                                        } else {
                                            location.href = 'https://dev.aiqingyinghang.com:2051/admin/project/story/detail.html?{"story_id":' + save_story_res.data.story.id + '}';
                                        }
                                    } else {
                                        console.log(save_story_res);
                                        alert('请求结果异常')
                                    }
                                },
                                error: function (res_save_column) {
                                    console.log(res_save_column);
                                    alert('网络异常');
                                }
                            })
                        }).create('button');


                        [form_edit.apiHandle.ele.input.version_id, form_edit.apiHandle.ele.input.project_id].forEach((selectInput) => {
                            selectInput.addEventListener('click', function () {
                                flushStoryItems({
                                    project_id_selectInput: form_edit.apiHandle.ele.input.project_id,
                                    version_id_selectInput: form_edit.apiHandle.ele.input.version_id,
                                    callbackFun: (storyDataRows) => {
                                        let tmp_items = [];
                                        storyDataRows.forEach((storyInfo) => {
                                            tmp_items.push({val: storyInfo.id, text: storyInfo.title});
                                        });
                                        form_edit.apiHandle.ele.input.parent_story_id.apiHandle.setItems(tmp_items);
                                        form_edit.apiHandle.ele.input.parent_story_id.apiHandle.setInitVal('0');
                                    }
                                });
                            });
                        });


                    }
                }
            );
        </script>
        <style>
            .hide {
                display: none;
            }

            .drag_sort_div {
                float: left;
                width: 100px;
            }

            .drag_sort_div > * {
                display: block;
                float: left;
            }

            .story_row {
                margin: 10px;
            }

            .story_row > td > div {
                display: block;
                padding: 10px;
            }

            .on_drag_row > td > div {
                background: #000;
                color: #FFF;
            }

            .on_drop_row > td > div {
                background: #ffff00;
                color: #00F;
            }

        </style>
    </div>
</div>


<footer class="footer">
    <div class="container">
        <p class="pull-left">#</p>

        <p class="pull-right">Powered by <a href="" rel="external">Hammer</a></p>
    </div>
</footer>

<script src="/static/file/admin/js/jquery.js"></script>
<script src="/static/file/admin/js/bootstrap.js"></script>
</body>
</html>
